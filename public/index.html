<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>脚本中心</title>
  <link href="/output.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <div class="container mx-auto px-4 py-8">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900">脚本中心</h1>
      <p class="text-gray-600 mt-2">由 Cloudflare Workers 驱动</p>
    </header>

    <main id="app">
      <p class="text-center text-gray-500">正在加载脚本列表...</p>
    </main>

    <footer class="text-center mt-12 text-gray-500 text-sm">
      <p>&copy; 2024. All rights reserved.</p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const app = document.getElementById('app');

      try {
        // 1. 获取脚本清单和下载统计
        const [manifestResponse, statsResponse] = await Promise.all([
          fetch('/script-manifest.json'),
          fetch('/api/stats')
        ]);

        if (!manifestResponse.ok) throw new Error('无法加载脚本清单');
        if (!statsResponse.ok) throw new Error('无法加载下载统计');

        const manifest = await manifestResponse.json();
        const stats = await statsResponse.json();

        app.innerHTML = ''; // 清空加载提示

        if (Object.keys(manifest).length === 0) {
          app.innerHTML = '<p class="text-center text-gray-500">没有找到任何脚本。</p>';
          return;
        }

        // 2. 渲染页面
        for (const category in manifest) {
          const categorySection = document.createElement('section');
          categorySection.className = 'mb-10';

          const categoryTitle = document.createElement('h2');
          categoryTitle.className = 'text-2xl font-semibold border-b-2 border-blue-500 pb-2 mb-4 capitalize';
          categoryTitle.textContent = category;
          categorySection.appendChild(categoryTitle);

          const scriptList = document.createElement('div'); // Changed from ul
          scriptList.className = 'space-y-4'; // Use space-y for vertical spacing
          
          manifest[category].forEach(script => {
            if (!script.details) return; // Skip scripts without details from README

            const detailsElement = document.createElement('details');
            detailsElement.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 group';

            const summaryElement = document.createElement('summary');
            summaryElement.className = 'p-5 cursor-pointer flex justify-between items-center list-none group-hover:bg-gray-50';
            
            const scriptName = document.createElement('h3');
            scriptName.textContent = script.name;
            scriptName.className = 'text-lg font-medium text-gray-900';

            const count = stats[script.key] || 0;
            const countSpan = document.createElement('span');
            countSpan.className = 'text-sm text-gray-500 mr-4';
            countSpan.textContent = `下载: ${count}`;
            
            const summaryContent = document.createElement('div');
            summaryContent.className = 'flex items-center';
            summaryContent.appendChild(scriptName);
            
            const summaryRight = document.createElement('div');
            summaryRight.className = 'flex items-center';
            summaryRight.appendChild(countSpan);
            // Add an arrow icon for open/close state
            summaryRight.innerHTML += `<svg class="w-5 h-5 text-gray-500 transform transition-transform duration-300 group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;

            summaryElement.appendChild(summaryContent);
            summaryElement.appendChild(summaryRight);

            const detailsContent = document.createElement('div');
            detailsContent.className = 'p-5 border-t border-gray-200';
            
            // Render markdown content only on first toggle
            detailsElement.addEventListener('toggle', event => {
               if (event.target.open && !detailsContent.dataset.rendered) {
                   const renderedHtml = marked.parse(script.details);
                   // Add prose class for typography styling from Tailwind
                   detailsContent.innerHTML = `<div class="prose prose-sm max-w-none">${renderedHtml}</div>`;
                   detailsContent.dataset.rendered = 'true';
                   
                   // Apply syntax highlighting to the new content
                   detailsContent.querySelectorAll('pre code').forEach((block) => {
                       hljs.highlightElement(block);
                   });

                   // Add copy buttons to code blocks
                   detailsContent.querySelectorAll('pre').forEach(pre => {
                       pre.style.position = 'relative';
                       const copyButton = document.createElement('button');
                       copyButton.textContent = '复制';
                       copyButton.className = 'absolute top-2 right-2 bg-gray-700 text-white px-2 py-1 rounded text-xs hover:bg-gray-800 transition-colors';
                       pre.appendChild(copyButton);
                       copyButton.addEventListener('click', () => {
                           const code = pre.querySelector('code').innerText;
                           navigator.clipboard.writeText(code).then(() => {
                               copyButton.textContent = '已复制!';
                               setTimeout(() => { copyButton.textContent = '复制'; }, 2000);
                           });
                       });
                   });
               }
            });

            detailsElement.appendChild(summaryElement);
            detailsElement.appendChild(detailsContent);
            scriptList.appendChild(detailsElement);
          });

          categorySection.appendChild(scriptList);
          app.appendChild(categorySection);
        }
      } catch (error) {
        console.error('加载脚本失败:', error);
        app.innerHTML = `<p class="text-center text-red-500">加载脚本失败: ${error.message}</p>`;
      }
    });
  </script>

</body>
</html>