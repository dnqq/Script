<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>脚本中心</title>
  <link href="/styles.css" rel="stylesheet">
  <script src="/vendor/marked.min.js"></script>
  <link rel="stylesheet" href="/vendor/atom-one-dark.min.css">
  <script src="/vendor/highlight.min.js"></script>
</head>
<body>
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="sidebar flex-shrink-0">
      <div class="p-6">
        <h1 class="text-2xl font-bold" style="color: var(--primary-color);">脚本中心</h1>
      </div>
      <nav id="category-nav" class="px-4 space-y-1">
        <a href="#" class="nav-link px-4 py-2" data-category="all">总览</a>
        <!-- Categories will be dynamically inserted here -->
      </nav>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <main id="app" class="flex-1 overflow-x-hidden overflow-y-auto p-8">
        <!-- Content will be rendered here -->
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p class="text-center text-secondary" style="margin-top: 1rem;">正在加载...</p>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const app = document.getElementById('app');
      const categoryNav = document.getElementById('category-nav');

      try {
        const [manifestResponse, statsResponse, todayStatsResponse] = await Promise.all([
          fetch('/script-manifest.json'),
          fetch('/api/stats'),
          fetch('/api/stats/today')
        ]);

        if (!manifestResponse.ok) throw new Error('无法加载脚本清单');
        if (!statsResponse.ok) throw new Error('无法加载下载统计');
        if (!todayStatsResponse.ok) throw new Error('无法加载今日下载统计');

        const manifest = await manifestResponse.json();
        const stats = await statsResponse.json();
        const todayStats = await todayStatsResponse.json();
        
        let totalScripts = 0;
        let totalDownloads = 0;
        for (const category in manifest) {
          const categoryData = manifest[category];
          let categoryTotalScripts = 0;
          if (categoryData._scripts) {
            categoryTotalScripts += categoryData._scripts.length;
          }
          for (const subCategory in categoryData) {
            if (subCategory !== '_scripts') {
              categoryTotalScripts += categoryData[subCategory].length;
              categoryData[subCategory].forEach(script => {
                totalDownloads += parseInt(stats[script.key] || '0', 10);
              });
            }
          }
          totalScripts += categoryTotalScripts;
        }

        // 渲染分类
        for (const category in manifest) {
          const categoryData = manifest[category];
          const hasSubCategories = Object.keys(categoryData).some(key => key !== '_scripts');

          const categoryElement = document.createElement('div');

          if (hasSubCategories) {
            categoryElement.innerHTML = `
              <details open>
                <summary class="nav-link px-4 py-2 flex items-center justify-between cursor-pointer">
                  <span class="capitalize font-medium">${category}</span>
                  <svg class="details-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </summary>
                <div class="pl-4 mt-1 space-y-1">
                  ${Object.keys(categoryData).filter(key => key !== '_scripts').map(subCategory => `
                    <a href="#" class="nav-link block px-4 py-2 text-sm" data-category="${category}" data-subcategory="${subCategory}">${subCategory}</a>
                  `).join('')}
                </div>
              </details>
            `;
          } else {
            const categoryLink = document.createElement('a');
            categoryLink.href = '#';
            categoryLink.className = 'nav-link block px-4 py-2 capitalize font-medium';
            categoryLink.textContent = category;
            categoryLink.dataset.category = category;
            categoryElement.appendChild(categoryLink);
          }
          categoryNav.appendChild(categoryElement);
        }

        // 初始渲染仪表盘
        renderDashboard();

        // 分类点击事件
        categoryNav.addEventListener('click', (e) => {
          const link = e.target.closest('a');
          if (link) {
            e.preventDefault();
            const category = link.dataset.category;
            const subcategory = link.dataset.subcategory;
            
            categoryNav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            if (category === 'all') {
              renderDashboard();
            } else {
              renderCategory(category, subcategory);
            }
          }
        });
        
        categoryNav.querySelector('a[data-category="all"]').classList.add('active');

        function renderDashboard() {
          // 收集所有脚本并按下载量排序
          const allScripts = [];
          for (const category in manifest) {
            const categoryData = manifest[category];
            if (categoryData._scripts) {
              categoryData._scripts.forEach(script => {
                allScripts.push({
                  ...script,
                  category: category,
                  subcategory: null,
                  downloads: parseInt(stats[script.key] || '0', 10)
                });
              });
            }
            for (const subCategory in categoryData) {
              if (subCategory !== '_scripts') {
                categoryData[subCategory].forEach(script => {
                  allScripts.push({
                    ...script,
                    category: category,
                    subcategory: subCategory,
                    downloads: parseInt(stats[script.key] || '0', 10)
                  });
                });
              }
            }
          }

          // 按下载量排序，取前8
          const topScripts = allScripts.sort((a, b) => b.downloads - a.downloads).slice(0, 8);

          // 统计每个分类的脚本数量
          const categoryStats = {};
          for (const category in manifest) {
            const categoryData = manifest[category];
            let count = 0;
            if (categoryData._scripts) {
              count += categoryData._scripts.length;
            }
            for (const subCategory in categoryData) {
              if (subCategory !== '_scripts') {
                count += categoryData[subCategory].length;
              }
            }
            categoryStats[category] = count;
          }

          app.innerHTML = `
            <div class="dashboard-header">
              <h2 class="text-3xl font-bold text-primary">总览</h2>
              <p class="text-secondary" style="margin-top: 0.5rem;">脚本中心数据统计</p>
            </div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #5b67f5 0%, #7c3aed 100%);">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <div class="stat-content">
                  <h3 class="text-sm font-medium text-secondary">脚本总数</h3>
                  <p class="stat-value">${totalScripts}</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                  </svg>
                </div>
                <div class="stat-content">
                  <h3 class="text-sm font-medium text-secondary">总下载量</h3>
                  <p class="stat-value">${totalDownloads.toLocaleString()}</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                  </svg>
                </div>
                <div class="stat-content">
                  <h3 class="text-sm font-medium text-secondary">今日下载</h3>
                  <p class="stat-value">${todayStats.today_downloads.toLocaleString()}</p>
                </div>
              </div>
            </div>

            <div class="dashboard-content-grid">
              <!-- 热门脚本排行榜 -->
              <div class="dashboard-section">
                <div class="section-header">
                  <h3 class="text-xl font-bold text-primary">热门脚本</h3>
                  <svg style="width: 1.25rem; height: 1.25rem; color: var(--primary-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                  </svg>
                </div>
                <div class="top-scripts-list">
                  ${topScripts.map((script, index) => {
                    const rawDescription = script.details.split('\n')[0];
                    const cleanedDescription = rawDescription.replace(/^\d+\.\s+\*\*(.*?)\*\*\s+-\s+/, '');
                    const title = cleanedDescription || script.name;
                    return `
                      <a href="#" class="top-script-item" data-category="${script.category}" data-subcategory="${script.subcategory || ''}">
                        <div class="rank-badge rank-${index + 1}">${index + 1}</div>
                        <div class="top-script-info">
                          <div class="top-script-name">${script.name}</div>
                          <div class="top-script-desc">${title}</div>
                        </div>
                        <div class="top-script-stats">
                          <svg style="width: 1rem; height: 1rem; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                          </svg>
                          <span>${script.downloads.toLocaleString()}</span>
                        </div>
                      </a>
                    `;
                  }).join('')}
                </div>
              </div>

              <!-- 分类统计 -->
              <div class="dashboard-section">
                <div class="section-header">
                  <h3 class="text-xl font-bold text-primary">分类统计</h3>
                  <svg style="width: 1.25rem; height: 1.25rem; color: var(--primary-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                  </svg>
                </div>
                <div class="category-stats-grid">
                  ${Object.entries(categoryStats).map(([category, count]) => `
                    <a href="#" class="category-stat-card" data-category="${category}">
                      <div class="category-stat-name">${category}</div>
                      <div class="category-stat-count">${count} 个脚本</div>
                    </a>
                  `).join('')}
                </div>
              </div>
            </div>
          `;

          // 添加热门脚本点击事件
          app.querySelectorAll('.top-script-item').forEach(item => {
            item.addEventListener('click', (e) => {
              e.preventDefault();
              const category = item.dataset.category;
              const subcategory = item.dataset.subcategory;
              categoryNav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
              const categoryLink = subcategory
                ? categoryNav.querySelector(`a[data-category="${category}"][data-subcategory="${subcategory}"]`)
                : categoryNav.querySelector(`a[data-category="${category}"]`);
              if (categoryLink) {
                categoryLink.classList.add('active');
                renderCategory(category, subcategory || null);
              }
            });
          });

          // 添加分类卡片点击事件
          app.querySelectorAll('.category-stat-card').forEach(card => {
            card.addEventListener('click', (e) => {
              e.preventDefault();
              const category = card.dataset.category;
              categoryNav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
              const categoryLink = categoryNav.querySelector(`a[data-category="${category}"]`);
              if (categoryLink) {
                categoryLink.classList.add('active');
                renderCategory(category);
              }
            });
          });
        }

        function renderCategory(category, subcategory) {
          let scripts;
          let title = category;

          if (subcategory) {
            scripts = manifest[category] && manifest[category][subcategory];
            title = `${category} / ${subcategory}`;
          } else {
            const categoryData = manifest[category];
            scripts = [];
            if (categoryData) {
              if (categoryData._scripts) {
                scripts = scripts.concat(categoryData._scripts);
              }
              for (const sub in categoryData) {
                if (sub !== '_scripts') {
                  scripts = scripts.concat(categoryData[sub]);
                }
              }
            }
          }

          if (!scripts || scripts.length === 0) {
            app.innerHTML = '<p class="text-secondary">未找到该分类下的脚本。</p>';
            return;
          }

          let currentSort = 'downloads';

          const renderScripts = (sortedScripts) => {
            const scriptListHtml = sortedScripts.map(script => {
              if (!script.details) return '';
              const count = stats[script.key] || 0;
              const rawDescription = script.details.split('\n')[0];
              const cleanedDescription = rawDescription.replace(/^\d+\.\s+\*\*(.*?)\*\*\s+-\s+/, '');
              const title = `${script.name} - ${cleanedDescription}`;
              
              return `
                <details class="details-card" data-script-name="${script.name}">
                  <summary class="details-summary">
                    <h3 class="text-base font-medium text-primary">${title}</h3>
                    <div class="flex items-center" style="gap: 1rem;">
                      <div class="download-count">
                        <svg style="width: 16px; height: 16px; opacity: 0.6;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>${count.toLocaleString()}</span>
                      </div>
                      <a href="/${script.key}?t=${new Date().getTime()}" download onclick="event.stopPropagation()" class="download-button">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>下载</span>
                      </a>
                      <svg class="details-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                  </summary>
                  <div class="details-content"></div>
                </details>
              `;
            }).join('');

            app.innerHTML = `
              <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-primary capitalize">${title}</h2>
                <div class="flex items-center" style="gap: 0.5rem;">
                  <span class="text-secondary text-sm">排序:</span>
                  <button data-sort="downloads" class="sort-button ${currentSort === 'downloads' ? 'active' : ''}">下载量</button>
                  <button data-sort="name" class="sort-button ${currentSort === 'name' ? 'active' : ''}">名称</button>
                </div>
              </div>
              <div class="space-y-4">${scriptListHtml}</div>
            `;
          };

          const sortAndRender = () => {
            let sortedScripts = [...scripts];
            if (currentSort === 'downloads') {
              sortedScripts.sort((a, b) => (stats[b.key] || 0) - (stats[a.key] || 0));
            } else if (currentSort === 'name') {
              sortedScripts.sort((a, b) => a.name.localeCompare(b.name));
            }
            renderScripts(sortedScripts);
          };
          
          sortAndRender();

          app.addEventListener('click', (e) => {
            const sortButton = e.target.closest('button[data-sort]');
            if (sortButton) {
              currentSort = sortButton.dataset.sort;
              sortAndRender();
            }
          });

          app.addEventListener('toggle', event => {
            const detailsElement = event.target;
            if (detailsElement.tagName === 'DETAILS') {
              const detailsContent = detailsElement.querySelector('.details-content');
              if (detailsElement.open && !detailsContent.dataset.rendered) {
                const scriptName = detailsElement.dataset.scriptName;
                const script = scripts.find(s => s.name === scriptName);
                if (script) {
                   const renderedHtml = marked.parse(script.details);
                   detailsContent.innerHTML = `<div class="prose">${renderedHtml}</div>`;
                   detailsContent.dataset.rendered = 'true';
                   
                   detailsContent.querySelectorAll('pre code').forEach((block) => {
                       hljs.highlightElement(block);
                   });

                   detailsContent.querySelectorAll('pre').forEach(pre => {
                       const copyButton = document.createElement('button');
                       copyButton.textContent = '复制';
                       copyButton.className = 'copy-button';
                       pre.appendChild(copyButton);
                       copyButton.addEventListener('click', () => {
                           const code = pre.querySelector('code').innerText;
                           navigator.clipboard.writeText(code).then(() => {
                               copyButton.textContent = '已复制!';
                               setTimeout(() => { copyButton.textContent = '复制'; }, 2000);
                           });
                       });
                   });
                }
              }
            }
          }, true);
        }

      } catch (error) {
        console.error('加载脚本失败:', error);
        app.innerHTML = `<p class="text-center" style="color: red;">加载脚本失败: ${error.message}</p>`;
      }
    });
  </script>

</body>
</html>