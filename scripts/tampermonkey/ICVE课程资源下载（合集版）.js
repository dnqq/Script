// ==UserScript==
// @name         ICVE课程资源下载（合集版）
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  支持下载队列状态显示、文件路径提示、去重等功能
// @author       ashin
// @match        https://zyk.icve.com.cn/icve-study/coursePreview/courseIndex
// @grant        GM_xmlhttpRequest
// @grant        GM_setClipboard
// @grant        GM_download
// @connect      zyk.icve.com.cn
// @connect      file.icve.com.cn
// @connect      *
// @require      data:text/javascript;base64,IWZ1bmN0aW9uKGUsdCl7Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzJiYidW5kZWZpbmVkIiE9dHlwZW9mIG1vZHVsZT9tb2R1bGUuZXhwb3J0cz10KCk6ImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUodCk6KGU9ZXx8c2VsZikuU3dlZXRhbGVydDI9dCgpfSh0aGlzLGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IHE9IlN3ZWV0QWxlcnQyOiIsSD1lPT5lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpK2Uuc2xpY2UoMSksaT1lPT5BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlKSxhPWU9Pntjb25zb2xlLndhcm4oIiIuY29uY2F0KHEsIiAiKS5jb25jYXQoIm9iamVjdCI9PXR5cGVvZiBlP2Uuam9pbigiICIpOmUpKX0sbD1lPT57Y29uc29sZS5lcnJvcigiIi5jb25jYXQocSwiICIpLmNvbmNhdChlKSl9LFY9W10sTj0oZSx0KT0+e2U9JyInLmNvbmNhdChlLCciIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBQbGVhc2UgdXNlICInKS5jb25jYXQodCwnIiBpbnN0ZWFkLicpLFYuaW5jbHVkZXMoZSl8fChWLnB1c2goZSksYShlKSl9LFI9ZT0+ImZ1bmN0aW9uIj09dHlwZW9mIGU/ZSgpOmUsRj1lPT5lJiYiZnVuY3Rpb24iPT10eXBlb2YgZS50b1Byb21pc2UsdT1lPT5GKGUpP2UudG9Qcm9taXNlKCk6UHJvbWlzZS5yZXNvbHZlKGUpLFU9ZT0+ZSYmUHJvbWlzZS5yZXNvbHZlKGUpPT09ZSxyPXt0aXRsZToiIix0aXRsZVRleHQ6IiIsdGV4dDoiIixodG1sOiIiLGZvb3RlcjoiIixpY29uOnZvaWQgMCxpY29uQ29sb3I6dm9pZCAwLGljb25IdG1sOnZvaWQgMCx0ZW1wbGF0ZTp2b2lkIDAsdG9hc3Q6ITEsc2hvd0NsYXNzOntwb3B1cDoic3dhbDItc2hvdyIsYmFja2Ryb3A6InN3YWwyLWJhY2tkcm9wLXNob3ciLGljb246InN3YWwyLWljb24tc2hvdyJ9LGhpZGVDbGFzczp7cG9wdXA6InN3YWwyLWhpZGUiLGJhY2tkcm9wOiJzd2FsMi1iYWNrZHJvcC1oaWRlIixpY29uOiJzd2FsMi1pY29uLWhpZGUifSxjdXN0b21DbGFzczp7fSx0YXJnZXQ6ImJvZHkiLGNvbG9yOnZvaWQgMCxiYWNrZHJvcDohMCxoZWlnaHRBdXRvOiEwLGFsbG93T3V0c2lkZUNsaWNrOiEwLGFsbG93RXNjYXBlS2V5OiEwLGFsbG93RW50ZXJLZXk6ITAsc3RvcEtleWRvd25Qcm9wYWdhdGlvbjohMCxrZXlkb3duTGlzdGVuZXJDYXB0dXJlOiExLHNob3dDb25maXJtQnV0dG9uOiEwLHNob3dEZW55QnV0dG9uOiExLHNob3dDYW5jZWxCdXR0b246ITEscHJlQ29uZmlybTp2b2lkIDAscHJlRGVueTp2b2lkIDAsY29uZmlybUJ1dHRvblRleHQ6Ik9LIixjb25maXJtQnV0dG9uQXJpYUxhYmVsOiIiLGNvbmZpcm1CdXR0b25Db2xvcjp2b2lkIDAsZGVueUJ1dHRvblRleHQ6Ik5vIixkZW55QnV0dG9uQXJpYUxhYmVsOiIiLGRlbnlCdXR0b25Db2xvcjp2b2lkIDAsY2FuY2VsQnV0dG9uVGV4dDoiQ2FuY2VsIixjYW5jZWxCdXR0b25BcmlhTGFiZWw6IiIsY2FuY2VsQnV0dG9uQ29sb3I6dm9pZCAwLGJ1dHRvbnNTdHlsaW5nOiEwLHJldmVyc2VCdXR0b25zOiExLGZvY3VzQ29uZmlybTohMCxmb2N1c0Rlbnk6ITEsZm9jdXNDYW5jZWw6ITEscmV0dXJuRm9jdXM6ITAsc2hvd0Nsb3NlQnV0dG9uOiExLGNsb3NlQnV0dG9uSHRtbDoiJnRpbWVzOyIsY2xvc2VCdXR0b25BcmlhTGFiZWw6IkNsb3NlIHRoaXMgZGlhbG9nIixsb2FkZXJIdG1sOiIiLHNob3dMb2FkZXJPbkNvbmZpcm06ITEsc2hvd0xvYWRlck9uRGVueTohMSxpbWFnZVVybDp2b2lkIDAsaW1hZ2VXaWR0aDp2b2lkIDAsaW1hZ2VIZWlnaHQ6dm9pZCAwLGltYWdlQWx0OiIiLHRpbWVyOnZvaWQgMCx0aW1lclByb2dyZXNzQmFyOiExLHdpZHRoOnZvaWQgMCxwYWRkaW5nOnZvaWQgMCxiYWNrZ3JvdW5kOnZvaWQgMCxpbnB1dDp2b2lkIDAsaW5wdXRQbGFjZWhvbGRlcjoiIixpbnB1dExhYmVsOiIiLGlucHV0VmFsdWU6IiIsaW5wdXRPcHRpb25zOnt9LGlucHV0QXV0b1RyaW06ITAsaW5wdXRBdHRyaWJ1dGVzOnt9LGlucHV0VmFsaWRhdG9yOnZvaWQgMCxyZXR1cm5JbnB1dFZhbHVlT25EZW55OiExLHZhbGlkYXRpb25NZXNzYWdlOnZvaWQgMCxncm93OiExLHBvc2l0aW9uOiJjZW50ZXIiLHByb2dyZXNzU3RlcHM6W10sY3VycmVudFByb2dyZXNzU3RlcDp2b2lkIDAscHJvZ3Jlc3NTdGVwc0Rpc3RhbmNlOnZvaWQgMCx3aWxsT3Blbjp2b2lkIDAsZGlkT3Blbjp2b2lkIDAsZGlkUmVuZGVyOnZvaWQgMCx3aWxsQ2xvc2U6dm9pZCAwLGRpZENsb3NlOnZvaWQgMCxkaWREZXN0cm95OnZvaWQgMCxzY3JvbGxiYXJQYWRkaW5nOiEwfSxXPVsiYWxsb3dFc2NhcGVLZXkiLCJhbGxvd091dHNpZGVDbGljayIsImJhY2tncm91bmQiLCJidXR0b25zU3R5bGluZyIsImNhbmNlbEJ1dHRvbkFyaWFMYWJlbCIsImNhbmNlbEJ1dHRvbkNvbG9yIiwiY2FuY2VsQnV0dG9uVGV4dCIsImNsb3NlQnV0dG9uQXJpYUxhYmVsIiwiY2xvc2VCdXR0b25IdG1sIiwiY29sb3IiLCJjb25maXJtQnV0dG9uQXJpYUxhYmVsIiwiY29uZmlybUJ1dHRvbkNvbG9yIiwiY29uZmlybUJ1dHRvblRleHQiLCJjdXJyZW50UHJvZ3Jlc3NTdGVwIiwiY3VzdG9tQ2xhc3MiLCJkZW55QnV0dG9uQXJpYUxhYmVsIiwiZGVueUJ1dHRvbkNvbG9yIiwiZGVueUJ1dHRvblRleHQiLCJkaWRDbG9zZSIsImRpZERlc3Ryb3kiLCJmb290ZXIiLCJoaWRlQ2xhc3MiLCJodG1sIiwiaWNvbiIsImljb25Db2xvciIsImljb25IdG1sIiwiaW1hZ2VBbHQiLCJpbWFnZUhlaWdodCIsImltYWdlVXJsIiwiaW1hZ2VXaWR0aCIsInByZUNvbmZpcm0iLCJwcmVEZW55IiwicHJvZ3Jlc3NTdGVwcyIsInJldHVybkZvY3VzIiwicmV2ZXJzZUJ1dHRvbnMiLCJzaG93Q2FuY2VsQnV0dG9uIiwic2hvd0Nsb3NlQnV0dG9uIiwic2hvd0NvbmZpcm1CdXR0b24iLCJzaG93RGVueUJ1dHRvbiIsInRleHQiLCJ0aXRsZSIsInRpdGxlVGV4dCIsIndpbGxDbG9zZSJdLHo9e30sXz1bImFsbG93T3V0c2lkZUNsaWNrIiwiYWxsb3dFbnRlcktleSIsImJhY2tkcm9wIiwiZm9jdXNDb25maXJtIiwiZm9jdXNEZW55IiwiZm9jdXNDYW5jZWwiLCJyZXR1cm5Gb2N1cyIsImhlaWdodEF1dG8iLCJrZXlkb3duTGlzdGVuZXJDYXB0dXJlIl0sSz1lPT5PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocixlKSxZPWU9Pi0xIT09Vy5pbmRleE9mKGUpLFo9ZT0+eltlXSxKPWU9PnshZS5iYWNrZHJvcCYmZS5hbGxvd091dHNpZGVDbGljayYmYSgnImFsbG93T3V0c2lkZUNsaWNrIiBwYXJhbWV0ZXIgcmVxdWlyZXMgYGJhY2tkcm9wYCBwYXJhbWV0ZXIgdG8gYmUgc2V0IHRvIGB0cnVlYCcpO2Zvcihjb25zdCBuIGluIGUpdD1uLEsodCl8fGEoJ1Vua25vd24gcGFyYW1ldGVyICInLmNvbmNhdCh0LCciJykpLGUudG9hc3QmJih0PW4sXy5pbmNsdWRlcyh0KSYmYSgnVGhlIHBhcmFtZXRlciAiJy5jb25jYXQodCwnIiBpcyBpbmNvbXBhdGlibGUgd2l0aCB0b2FzdHMnKSkpLHQ9bixaKHQpJiZOKHQsWih0KSk7dmFyIHR9O3ZhciBlPWU9Pntjb25zdCB0PXt9O2Zvcihjb25zdCBuIGluIGUpdFtlW25dXT0ic3dhbDItIitlW25dO3JldHVybiB0fTtjb25zdCBwPWUoWyJjb250YWluZXIiLCJzaG93biIsImhlaWdodC1hdXRvIiwiaW9zZml4IiwicG9wdXAiLCJtb2RhbCIsIm5vLWJhY2tkcm9wIiwibm8tdHJhbnNpdGlvbiIsInRvYXN0IiwidG9hc3Qtc2hvd24iLCJzaG93IiwiaGlkZSIsImNsb3NlIiwidGl0bGUiLCJodG1sLWNvbnRhaW5lciIsImFjdGlvbnMiLCJjb25maXJtIiwiZGVueSIsImNhbmNlbCIsImRlZmF1bHQtb3V0bGluZSIsImZvb3RlciIsImljb24iLCJpY29uLWNvbnRlbnQiLCJpbWFnZSIsImlucHV0IiwiZmlsZSIsInJhbmdlIiwic2VsZWN0IiwicmFkaW8iLCJjaGVja2JveCIsImxhYmVsIiwidGV4dGFyZWEiLCJpbnB1dGVycm9yIiwiaW5wdXQtbGFiZWwiLCJ2YWxpZGF0aW9uLW1lc3NhZ2UiLCJwcm9ncmVzcy1zdGVwcyIsImFjdGl2ZS1wcm9ncmVzcy1zdGVwIiwicHJvZ3Jlc3Mtc3RlcCIsInByb2dyZXNzLXN0ZXAtbGluZSIsImxvYWRlciIsImxvYWRpbmciLCJzdHlsZWQiLCJ0b3AiLCJ0b3Atc3RhcnQiLCJ0b3AtZW5kIiwidG9wLWxlZnQiLCJ0b3AtcmlnaHQiLCJjZW50ZXIiLCJjZW50ZXItc3RhcnQiLCJjZW50ZXItZW5kIiwiY2VudGVyLWxlZnQiLCJjZW50ZXItcmlnaHQiLCJib3R0b20iLCJib3R0b20tc3RhcnQiLCJib3R0b20tZW5kIiwiYm90dG9tLWxlZnQiLCJib3R0b20tcmlnaHQiLCJncm93LXJvdyIsImdyb3ctY29sdW1uIiwiZ3Jvdy1mdWxsc2NyZWVuIiwicnRsIiwidGltZXItcHJvZ3Jlc3MtYmFyIiwidGltZXItcHJvZ3Jlc3MtYmFyLWNvbnRhaW5lciIsInNjcm9sbGJhci1tZWFzdXJlIiwiaWNvbi1zdWNjZXNzIiwiaWNvbi13YXJuaW5nIiwiaWNvbi1pbmZvIiwiaWNvbi1xdWVzdGlvbiIsImljb24tZXJyb3IiXSksbz1lKFsic3VjY2VzcyIsIndhcm5pbmciLCJpbmZvIiwicXVlc3Rpb24iLCJlcnJvciJdKSxtPSgpPT5kb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoIi4iLmNvbmNhdChwLmNvbnRhaW5lcikpLHQ9ZT0+e2NvbnN0IHQ9bSgpO3JldHVybiB0P3QucXVlcnlTZWxlY3RvcihlKTpudWxsfSxuPWU9PnQoIi4iLmNvbmNhdChlKSksZz0oKT0+bihwLnBvcHVwKSxzPSgpPT5uKHAuaWNvbiksWD0oKT0+bihwLnRpdGxlKSwkPSgpPT5uKHBbImh0bWwtY29udGFpbmVyIl0pLEc9KCk9Pm4ocC5pbWFnZSksUT0oKT0+bihwWyJwcm9ncmVzcy1zdGVwcyJdKSxlZT0oKT0+bihwWyJ2YWxpZGF0aW9uLW1lc3NhZ2UiXSksaD0oKT0+dCgiLiIuY29uY2F0KHAuYWN0aW9ucywiIC4iKS5jb25jYXQocC5jb25maXJtKSksZj0oKT0+dCgiLiIuY29uY2F0KHAuYWN0aW9ucywiIC4iKS5jb25jYXQocC5kZW55KSk7Y29uc3QgZD0oKT0+dCgiLiIuY29uY2F0KHAubG9hZGVyKSksYj0oKT0+dCgiLiIuY29uY2F0KHAuYWN0aW9ucywiIC4iKS5jb25jYXQocC5jYW5jZWwpKSx2PSgpPT5uKHAuYWN0aW9ucyksdGU9KCk9Pm4ocC5mb290ZXIpLG5lPSgpPT5uKHBbInRpbWVyLXByb2dyZXNzLWJhciJdKSxvZT0oKT0+bihwLmNsb3NlKSxpZT0oKT0+e2NvbnN0IGU9aShnKCkucXVlcnlTZWxlY3RvckFsbCgnW3RhYmluZGV4XTpub3QoW3RhYmluZGV4PSItMSJdKTpub3QoW3RhYmluZGV4PSIwIl0pJykpLnNvcnQoKGUsdCk9PntlPXBhcnNlSW50KGUuZ2V0QXR0cmlidXRlKCJ0YWJpbmRleCIpKSx0PXBhcnNlSW50KHQuZ2V0QXR0cmlidXRlKCJ0YWJpbmRleCIpKTtyZXR1cm4gdDxlPzE6ZTx0Py0xOjB9KTt2YXIgdD1pKGcoKS5xdWVyeVNlbGVjdG9yQWxsKCdcbiAgYVtocmVmXSxcbiAgYXJlYVtocmVmXSxcbiAgaW5wdXQ6bm90KFtkaXNhYmxlZF0pLFxuICBzZWxlY3Q6bm90KFtkaXNhYmxlZF0pLFxuICB0ZXh0YXJlYTpub3QoW2Rpc2FibGVkXSksXG4gIGJ1dHRvbjpub3QoW2Rpc2FibGVkXSksXG4gIGlmcmFtZSxcbiAgb2JqZWN0LFxuICBlbWJlZCxcbiAgW3RhYmluZGV4PSIwIl0sXG4gIFtjb250ZW50ZWRpdGFibGVdLFxuICBhdWRpb1tjb250cm9sc10sXG4gIHZpZGVvW2NvbnRyb2xzXSxcbiAgc3VtbWFyeVxuJykpLmZpbHRlcihlPT4iLTEiIT09ZS5nZXRBdHRyaWJ1dGUoInRhYmluZGV4IikpO3JldHVybih0PT57Y29uc3Qgbj1bXTtmb3IobGV0IGU9MDtlPHQubGVuZ3RoO2UrKyktMT09PW4uaW5kZXhPZih0W2VdKSYmbi5wdXNoKHRbZV0pO3JldHVybiBufSkoZS5jb25jYXQodCkpLmZpbHRlcihlPT5FKGUpKX0sYWU9KCk9PncoZG9jdW1lbnQuYm9keSxwLnNob3duKSYmIXcoZG9jdW1lbnQuYm9keSxwWyJ0b2FzdC1zaG93biJdKSYmIXcoZG9jdW1lbnQuYm9keSxwWyJuby1iYWNrZHJvcCJdKSxyZT0oKT0+ZygpJiZ3KGcoKSxwLnRvYXN0KTtmdW5jdGlvbiBzZShlKXt2YXIgdD0xPGFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXSYmYXJndW1lbnRzWzFdO2NvbnN0IG49bmUoKTtFKG4pJiYodCYmKG4uc3R5bGUudHJhbnNpdGlvbj0ibm9uZSIsbi5zdHlsZS53aWR0aD0iMTAwJSIpLHNldFRpbWVvdXQoKCk9PntuLnN0eWxlLnRyYW5zaXRpb249IndpZHRoICIuY29uY2F0KGUvMWUzLCJzIGxpbmVhciIpLG4uc3R5bGUud2lkdGg9IjAlIn0sMTApKX1jb25zdCBjPXtwcmV2aW91c0JvZHlQYWRkaW5nOm51bGx9LHk9KHQsZSk9PntpZih0LnRleHRDb250ZW50PSIiLGUpe2NvbnN0IG49bmV3IERPTVBhcnNlcixvPW4ucGFyc2VGcm9tU3RyaW5nKGUsInRleHQvaHRtbCIpO2koby5xdWVyeVNlbGVjdG9yKCJoZWFkIikuY2hpbGROb2RlcykuZm9yRWFjaChlPT57dC5hcHBlbmRDaGlsZChlKX0pLGkoby5xdWVyeVNlbGVjdG9yKCJib2R5IikuY2hpbGROb2RlcykuZm9yRWFjaChlPT57dC5hcHBlbmRDaGlsZChlKX0pfX0sdz0odCxlKT0+e2lmKCFlKXJldHVybiExO3ZhciBuPWUuc3BsaXQoL1xzKy8pO2ZvcihsZXQgZT0wO2U8bi5sZW5ndGg7ZSsrKWlmKCF0LmNsYXNzTGlzdC5jb250YWlucyhuW2VdKSlyZXR1cm4hMTtyZXR1cm4hMH0sY2U9KHQsbik9PntpKHQuY2xhc3NMaXN0KS5mb3JFYWNoKGU9PntPYmplY3QudmFsdWVzKHApLmluY2x1ZGVzKGUpfHxPYmplY3QudmFsdWVzKG8pLmluY2x1ZGVzKGUpfHxPYmplY3QudmFsdWVzKG4uc2hvd0NsYXNzKS5pbmNsdWRlcyhlKXx8dC5jbGFzc0xpc3QucmVtb3ZlKGUpfSl9LEM9KGUsdCxuKT0+e2lmKGNlKGUsdCksdC5jdXN0b21DbGFzcyYmdC5jdXN0b21DbGFzc1tuXSl7aWYoInN0cmluZyIhPXR5cGVvZiB0LmN1c3RvbUNsYXNzW25dJiYhdC5jdXN0b21DbGFzc1tuXS5mb3JFYWNoKXJldHVybiBhKCJJbnZhbGlkIHR5cGUgb2YgY3VzdG9tQ2xhc3MuIi5jb25jYXQobiwnISBFeHBlY3RlZCBzdHJpbmcgb3IgaXRlcmFibGUgb2JqZWN0LCBnb3QgIicpLmNvbmNhdCh0eXBlb2YgdC5jdXN0b21DbGFzc1tuXSwnIicpKTtBKGUsdC5jdXN0b21DbGFzc1tuXSl9fSxsZT0oZSx0KT0+e2lmKCF0KXJldHVybiBudWxsO3N3aXRjaCh0KXtjYXNlInNlbGVjdCI6Y2FzZSJ0ZXh0YXJlYSI6Y2FzZSJmaWxlIjpyZXR1cm4gZS5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQocC5wb3B1cCwiID4gLiIpLmNvbmNhdChwW3RdKSk7Y2FzZSJjaGVja2JveCI6cmV0dXJuIGUucXVlcnlTZWxlY3RvcigiLiIuY29uY2F0KHAucG9wdXAsIiA+IC4iKS5jb25jYXQocC5jaGVja2JveCwiIGlucHV0IikpO2Nhc2UicmFkaW8iOnJldHVybiBlLnF1ZXJ5U2VsZWN0b3IoIi4iLmNvbmNhdChwLnBvcHVwLCIgPiAuIikuY29uY2F0KHAucmFkaW8sIiBpbnB1dDpjaGVja2VkIikpfHxlLnF1ZXJ5U2VsZWN0b3IoIi4iLmNvbmNhdChwLnBvcHVwLCIgPiAuIikuY29uY2F0KHAucmFkaW8sIiBpbnB1dDpmaXJzdC1jaGlsZCIpKTtjYXNlInJhbmdlIjpyZXR1cm4gZS5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQocC5wb3B1cCwiID4gLiIpLmNvbmNhdChwLnJhbmdlLCIgaW5wdXQiKSk7ZGVmYXVsdDpyZXR1cm4gZS5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQocC5wb3B1cCwiID4gLiIpLmNvbmNhdChwLmlucHV0KSl9fSx1ZT1lPT57dmFyIHQ7ZS5mb2N1cygpLCJmaWxlIiE9PWUudHlwZSYmKHQ9ZS52YWx1ZSxlLnZhbHVlPSIiLGUudmFsdWU9dCl9LGRlPShlLHQsbik9PntlJiZ0JiYodD0ic3RyaW5nIj09dHlwZW9mIHQ/dC5zcGxpdCgvXHMrLykuZmlsdGVyKEJvb2xlYW4pOnQpLmZvckVhY2godD0+e0FycmF5LmlzQXJyYXkoZSk/ZS5mb3JFYWNoKGU9PntuP2UuY2xhc3NMaXN0LmFkZCh0KTplLmNsYXNzTGlzdC5yZW1vdmUodCl9KTpuP2UuY2xhc3NMaXN0LmFkZCh0KTplLmNsYXNzTGlzdC5yZW1vdmUodCl9KX0sQT0oZSx0KT0+e2RlKGUsdCwhMCl9LGs9KGUsdCk9PntkZShlLHQsITEpfSxQPShlLHQpPT57dmFyIG49aShlLmNoaWxkTm9kZXMpO2ZvcihsZXQgZT0wO2U8bi5sZW5ndGg7ZSsrKWlmKHcobltlXSx0KSlyZXR1cm4gbltlXX0scGU9KGUsdCxuKT0+eyhuPW49PT0iIi5jb25jYXQocGFyc2VJbnQobikpP3BhcnNlSW50KG4pOm4pfHwwPT09cGFyc2VJbnQobik/ZS5zdHlsZVt0XT0ibnVtYmVyIj09dHlwZW9mIG4/IiIuY29uY2F0KG4sInB4Iik6bjplLnN0eWxlLnJlbW92ZVByb3BlcnR5KHQpfSxCPWZ1bmN0aW9uKGUpe2Uuc3R5bGUuZGlzcGxheT0xPGFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06ImZsZXgifSx4PWU9PntlLnN0eWxlLmRpc3BsYXk9Im5vbmUifSxtZT0oZSx0LG4sbyk9Pntjb25zdCBpPWUucXVlcnlTZWxlY3Rvcih0KTtpJiYoaS5zdHlsZVtuXT1vKX0sZ2U9KGUsdCxuKT0+e3Q/QihlLG4pOngoZSl9LEU9ZT0+ISghZXx8IShlLm9mZnNldFdpZHRofHxlLm9mZnNldEhlaWdodHx8ZS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCkpLGhlPSgpPT4hRShoKCkpJiYhRShmKCkpJiYhRShiKCkpLGZlPWU9PiEhKGUuc2Nyb2xsSGVpZ2h0PmUuY2xpZW50SGVpZ2h0KSxiZT1lPT57Y29uc3QgdD13aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlKTt2YXIgZT1wYXJzZUZsb2F0KHQuZ2V0UHJvcGVydHlWYWx1ZSgiYW5pbWF0aW9uLWR1cmF0aW9uIil8fCIwIiksbj1wYXJzZUZsb2F0KHQuZ2V0UHJvcGVydHlWYWx1ZSgidHJhbnNpdGlvbi1kdXJhdGlvbiIpfHwiMCIpO3JldHVybiAwPGV8fDA8bn0sdmU9KCk9PiJ1bmRlZmluZWQiPT10eXBlb2Ygd2luZG93fHwidW5kZWZpbmVkIj09dHlwZW9mIGRvY3VtZW50LHllPTEwMCxUPXt9LHdlPSgpPT57VC5wcmV2aW91c0FjdGl2ZUVsZW1lbnQmJlQucHJldmlvdXNBY3RpdmVFbGVtZW50LmZvY3VzPyhULnByZXZpb3VzQWN0aXZlRWxlbWVudC5mb2N1cygpLFQucHJldmlvdXNBY3RpdmVFbGVtZW50PW51bGwpOmRvY3VtZW50LmJvZHkmJmRvY3VtZW50LmJvZHkuZm9jdXMoKX0sQ2U9bz0+bmV3IFByb21pc2UoZT0+e2lmKCFvKXJldHVybiBlKCk7dmFyIHQ9d2luZG93LnNjcm9sbFgsbj13aW5kb3cuc2Nyb2xsWTtULnJlc3RvcmVGb2N1c1RpbWVvdXQ9c2V0VGltZW91dCgoKT0+e3dlKCksZSgpfSx5ZSksd2luZG93LnNjcm9sbFRvKHQsbil9KSxBZT0nXG4gPGRpdiBhcmlhLWxhYmVsbGVkYnk9IicuY29uY2F0KHAudGl0bGUsJyIgYXJpYS1kZXNjcmliZWRieT0iJykuY29uY2F0KHBbImh0bWwtY29udGFpbmVyIl0sJyIgY2xhc3M9IicpLmNvbmNhdChwLnBvcHVwLCciIHRhYmluZGV4PSItMSI+XG4gICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9IicpLmNvbmNhdChwLmNsb3NlLCciPjwvYnV0dG9uPlxuICAgPHVsIGNsYXNzPSInKS5jb25jYXQocFsicHJvZ3Jlc3Mtc3RlcHMiXSwnIj48L3VsPlxuICAgPGRpdiBjbGFzcz0iJykuY29uY2F0KHAuaWNvbiwnIj48L2Rpdj5cbiAgIDxpbWcgY2xhc3M9IicpLmNvbmNhdChwLmltYWdlLCciIC8+XG4gICA8aDIgY2xhc3M9IicpLmNvbmNhdChwLnRpdGxlLCciIGlkPSInKS5jb25jYXQocC50aXRsZSwnIj48L2gyPlxuICAgPGRpdiBjbGFzcz0iJykuY29uY2F0KHBbImh0bWwtY29udGFpbmVyIl0sJyIgaWQ9IicpLmNvbmNhdChwWyJodG1sLWNvbnRhaW5lciJdLCciPjwvZGl2PlxuICAgPGlucHV0IGNsYXNzPSInKS5jb25jYXQocC5pbnB1dCwnIiAvPlxuICAgPGlucHV0IHR5cGU9ImZpbGUiIGNsYXNzPSInKS5jb25jYXQocC5maWxlLCciIC8+XG4gICA8ZGl2IGNsYXNzPSInKS5jb25jYXQocC5yYW5nZSwnIj5cbiAgICAgPGlucHV0IHR5cGU9InJhbmdlIiAvPlxuICAgICA8b3V0cHV0Pjwvb3V0cHV0PlxuICAgPC9kaXY+XG4gICA8c2VsZWN0IGNsYXNzPSInKS5jb25jYXQocC5zZWxlY3QsJyI+PC9zZWxlY3Q+XG4gICA8ZGl2IGNsYXNzPSInKS5jb25jYXQocC5yYWRpbywnIj48L2Rpdj5cbiAgIDxsYWJlbCBmb3I9IicpLmNvbmNhdChwLmNoZWNrYm94LCciIGNsYXNzPSInKS5jb25jYXQocC5jaGVja2JveCwnIj5cbiAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiAvPlxuICAgICA8c3BhbiBjbGFzcz0iJykuY29uY2F0KHAubGFiZWwsJyI+PC9zcGFuPlxuICAgPC9sYWJlbD5cbiAgIDx0ZXh0YXJlYSBjbGFzcz0iJykuY29uY2F0KHAudGV4dGFyZWEsJyI+PC90ZXh0YXJlYT5cbiAgIDxkaXYgY2xhc3M9IicpLmNvbmNhdChwWyJ2YWxpZGF0aW9uLW1lc3NhZ2UiXSwnIiBpZD0iJykuY29uY2F0KHBbInZhbGlkYXRpb24tbWVzc2FnZSJdLCciPjwvZGl2PlxuICAgPGRpdiBjbGFzcz0iJykuY29uY2F0KHAuYWN0aW9ucywnIj5cbiAgICAgPGRpdiBjbGFzcz0iJykuY29uY2F0KHAubG9hZGVyLCciPjwvZGl2PlxuICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9IicpLmNvbmNhdChwLmNvbmZpcm0sJyI+PC9idXR0b24+XG4gICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iJykuY29uY2F0KHAuZGVueSwnIj48L2J1dHRvbj5cbiAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSInKS5jb25jYXQocC5jYW5jZWwsJyI+PC9idXR0b24+XG4gICA8L2Rpdj5cbiAgIDxkaXYgY2xhc3M9IicpLmNvbmNhdChwLmZvb3RlciwnIj48L2Rpdj5cbiAgIDxkaXYgY2xhc3M9IicpLmNvbmNhdChwWyJ0aW1lci1wcm9ncmVzcy1iYXItY29udGFpbmVyIl0sJyI+XG4gICAgIDxkaXYgY2xhc3M9IicpLmNvbmNhdChwWyJ0aW1lci1wcm9ncmVzcy1iYXIiXSwnIj48L2Rpdj5cbiAgIDwvZGl2PlxuIDwvZGl2PlxuJykucmVwbGFjZSgvKF58XG4pXHMqL2csIiIpLGtlPSgpPT57Y29uc3QgZT1tKCk7cmV0dXJuISFlJiYoZS5yZW1vdmUoKSxrKFtkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsZG9jdW1lbnQuYm9keV0sW3BbIm5vLWJhY2tkcm9wIl0scFsidG9hc3Qtc2hvd24iXSxwWyJoYXMtY29sdW1uIl1dKSwhMCl9LFM9KCk9PntULmN1cnJlbnRJbnN0YW5jZS5yZXNldFZhbGlkYXRpb25NZXNzYWdlKCl9LFBlPSgpPT57Y29uc3QgZT1nKCksdD1QKGUscC5pbnB1dCksbj1QKGUscC5maWxlKSxvPWUucXVlcnlTZWxlY3RvcigiLiIuY29uY2F0KHAucmFuZ2UsIiBpbnB1dCIpKSxpPWUucXVlcnlTZWxlY3RvcigiLiIuY29uY2F0KHAucmFuZ2UsIiBvdXRwdXQiKSksYT1QKGUscC5zZWxlY3QpLHI9ZS5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQocC5jaGVja2JveCwiIGlucHV0IikpLHM9UChlLHAudGV4dGFyZWEpO3Qub25pbnB1dD1TLG4ub25jaGFuZ2U9UyxhLm9uY2hhbmdlPVMsci5vbmNoYW5nZT1TLHMub25pbnB1dD1TLG8ub25pbnB1dD0oKT0+e1MoKSxpLnZhbHVlPW8udmFsdWV9LG8ub25jaGFuZ2U9KCk9PntTKCksby5uZXh0U2libGluZy52YWx1ZT1vLnZhbHVlfX0sQmU9ZT0+InN0cmluZyI9PXR5cGVvZiBlP2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZSk6ZSx4ZT1lPT57Y29uc3QgdD1nKCk7dC5zZXRBdHRyaWJ1dGUoInJvbGUiLGUudG9hc3Q/ImFsZXJ0IjoiZGlhbG9nIiksdC5zZXRBdHRyaWJ1dGUoImFyaWEtbGl2ZSIsZS50b2FzdD8icG9saXRlIjoiYXNzZXJ0aXZlIiksZS50b2FzdHx8dC5zZXRBdHRyaWJ1dGUoImFyaWEtbW9kYWwiLCJ0cnVlIil9LEVlPWU9PnsicnRsIj09PXdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGUpLmRpcmVjdGlvbiYmQShtKCkscC5ydGwpfSxUZT0oZSx0KT0+e2lmKGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCl0LmFwcGVuZENoaWxkKGUpO2Vsc2UgaWYoIm9iamVjdCI9PXR5cGVvZiBlKXt2YXIgbj1lLG89dDtpZihuLmpxdWVyeSlTZShvLG4pO2Vsc2UgeShvLG4udG9TdHJpbmcoKSl9ZWxzZSBlJiZ5KHQsZSl9LFNlPSh0LG4pPT57aWYodC50ZXh0Q29udGVudD0iIiwwIGluIG4pZm9yKGxldCBlPTA7ZSBpbiBuO2UrKyl0LmFwcGVuZENoaWxkKG5bZV0uY2xvbmVOb2RlKCEwKSk7ZWxzZSB0LmFwcGVuZENoaWxkKG4uY2xvbmVOb2RlKCEwKSl9LExlPSgoKT0+e2lmKHZlKCkpcmV0dXJuITE7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksdD17V2Via2l0QW5pbWF0aW9uOiJ3ZWJraXRBbmltYXRpb25FbmQiLGFuaW1hdGlvbjoiYW5pbWF0aW9uZW5kIn07Zm9yKGNvbnN0IG4gaW4gdClpZihPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodCxuKSYmdm9pZCAwIT09ZS5zdHlsZVtuXSlyZXR1cm4gdFtuXTtyZXR1cm4hMX0pKCksT2U9KGUsdCk9Pnt2YXIgbixvLGksYSxyLHM9digpLGM9ZCgpOyh0LnNob3dDb25maXJtQnV0dG9ufHx0LnNob3dEZW55QnV0dG9ufHx0LnNob3dDYW5jZWxCdXR0b24/Qjp4KShzKSxDKHMsdCwiYWN0aW9ucyIpLHM9cyxuPWMsbz10LGk9aCgpLGE9ZigpLHI9YigpLGplKGksImNvbmZpcm0iLG8pLGplKGEsImRlbnkiLG8pLGplKHIsImNhbmNlbCIsbyksZnVuY3Rpb24oZSx0LG4sbyl7aWYoIW8uYnV0dG9uc1N0eWxpbmcpcmV0dXJuIGsoW2UsdCxuXSxwLnN0eWxlZCk7QShbZSx0LG5dLHAuc3R5bGVkKSxvLmNvbmZpcm1CdXR0b25Db2xvciYmKGUuc3R5bGUuYmFja2dyb3VuZENvbG9yPW8uY29uZmlybUJ1dHRvbkNvbG9yLEEoZSxwWyJkZWZhdWx0LW91dGxpbmUiXSkpO28uZGVueUJ1dHRvbkNvbG9yJiYodC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3I9by5kZW55QnV0dG9uQ29sb3IsQSh0LHBbImRlZmF1bHQtb3V0bGluZSJdKSk7by5jYW5jZWxCdXR0b25Db2xvciYmKG4uc3R5bGUuYmFja2dyb3VuZENvbG9yPW8uY2FuY2VsQnV0dG9uQ29sb3IsQShuLHBbImRlZmF1bHQtb3V0bGluZSJdKSl9KGksYSxyLG8pLG8ucmV2ZXJzZUJ1dHRvbnMmJihvLnRvYXN0PyhzLmluc2VydEJlZm9yZShyLGkpLHMuaW5zZXJ0QmVmb3JlKGEsaSkpOihzLmluc2VydEJlZm9yZShyLG4pLHMuaW5zZXJ0QmVmb3JlKGEsbikscy5pbnNlcnRCZWZvcmUoaSxuKSkpLHkoYyx0LmxvYWRlckh0bWwpLEMoYyx0LCJsb2FkZXIiKX07ZnVuY3Rpb24gamUoZSx0LG4pe2dlKGUsblsic2hvdyIuY29uY2F0KEgodCksIkJ1dHRvbiIpXSwiaW5saW5lLWJsb2NrIikseShlLG5bIiIuY29uY2F0KHQsIkJ1dHRvblRleHQiKV0pLGUuc2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIixuWyIiLmNvbmNhdCh0LCJCdXR0b25BcmlhTGFiZWwiKV0pLGUuY2xhc3NOYW1lPXBbdF0sQyhlLG4sIiIuY29uY2F0KHQsIkJ1dHRvbiIpKSxBKGUsblsiIi5jb25jYXQodCwiQnV0dG9uQ2xhc3MiKV0pfWNvbnN0IE1lPShlLHQpPT57dmFyIG4sbyxpPW0oKTtpJiYobz1pLCJzdHJpbmciPT10eXBlb2Yobj10LmJhY2tkcm9wKT9vLnN0eWxlLmJhY2tncm91bmQ9bjpufHxBKFtkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsZG9jdW1lbnQuYm9keV0scFsibm8tYmFja2Ryb3AiXSksbz1pLChuPXQucG9zaXRpb24paW4gcD9BKG8scFtuXSk6KGEoJ1RoZSAicG9zaXRpb24iIHBhcmFtZXRlciBpcyBub3QgdmFsaWQsIGRlZmF1bHRpbmcgdG8gImNlbnRlciInKSxBKG8scC5jZW50ZXIpKSxuPWksKG89dC5ncm93KSYmInN0cmluZyI9PXR5cGVvZiBvJiYobz0iZ3Jvdy0iLmNvbmNhdChvKSlpbiBwJiZBKG4scFtvXSksQyhpLHQsImNvbnRhaW5lciIpKX07dmFyIEw9e2F3YWl0aW5nUHJvbWlzZTpuZXcgV2Vha01hcCxwcm9taXNlOm5ldyBXZWFrTWFwLGlubmVyUGFyYW1zOm5ldyBXZWFrTWFwLGRvbUNhY2hlOm5ldyBXZWFrTWFwfTtjb25zdCBEZT1bImlucHV0IiwiZmlsZSIsInJhbmdlIiwic2VsZWN0IiwicmFkaW8iLCJjaGVja2JveCIsInRleHRhcmVhIl0sSWU9KGUscik9Pntjb25zdCBzPWcoKTt2YXIgdCxlPUwuaW5uZXJQYXJhbXMuZ2V0KGUpO2NvbnN0IGM9IWV8fHIuaW5wdXQhPT1lLmlucHV0O0RlLmZvckVhY2goZT0+e3ZhciB0PXBbZV07Y29uc3Qgbj1QKHMsdCk7e3ZhciBvPXIuaW5wdXRBdHRyaWJ1dGVzO2NvbnN0IGk9bGUoZygpLGUpO2lmKGkpe3FlKGkpO2Zvcihjb25zdCBhIGluIG8paS5zZXRBdHRyaWJ1dGUoYSxvW2FdKX19bi5jbGFzc05hbWU9dCxjJiZ4KG4pfSksci5pbnB1dCYmKGMmJihlPT57aWYoIU9bZS5pbnB1dF0pcmV0dXJuIGwoJ1VuZXhwZWN0ZWQgdHlwZSBvZiBpbnB1dCEgRXhwZWN0ZWQgInRleHQiLCAiZW1haWwiLCAicGFzc3dvcmQiLCAibnVtYmVyIiwgInRlbCIsICJzZWxlY3QiLCAicmFkaW8iLCAiY2hlY2tib3giLCAidGV4dGFyZWEiLCAiZmlsZSIgb3IgInVybCIsIGdvdCAiJy5jb25jYXQoZS5pbnB1dCwnIicpKTtjb25zdCB0PU5lKGUuaW5wdXQpLG49T1tlLmlucHV0XSh0LGUpO0Iobiksc2V0VGltZW91dCgoKT0+e3VlKG4pfSl9KShyKSxlPXIsdD1OZShlLmlucHV0KSxlLmN1c3RvbUNsYXNzJiZBKHQsZS5jdXN0b21DbGFzcy5pbnB1dCkpfSxxZT10PT57Zm9yKGxldCBlPTA7ZTx0LmF0dHJpYnV0ZXMubGVuZ3RoO2UrKyl7dmFyIG49dC5hdHRyaWJ1dGVzW2VdLm5hbWU7WyJ0eXBlIiwidmFsdWUiLCJzdHlsZSJdLmluY2x1ZGVzKG4pfHx0LnJlbW92ZUF0dHJpYnV0ZShuKX19LEhlPShlLHQpPT57ZS5wbGFjZWhvbGRlciYmIXQuaW5wdXRQbGFjZWhvbGRlcnx8KGUucGxhY2Vob2xkZXI9dC5pbnB1dFBsYWNlaG9sZGVyKX0sVmU9KGUsdCxuKT0+e2lmKG4uaW5wdXRMYWJlbCl7ZS5pZD1wLmlucHV0O2NvbnN0IGk9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTt2YXIgbz1wWyJpbnB1dC1sYWJlbCJdO2kuc2V0QXR0cmlidXRlKCJmb3IiLGUuaWQpLGkuY2xhc3NOYW1lPW8sQShpLG4uY3VzdG9tQ2xhc3MuaW5wdXRMYWJlbCksaS5pbm5lclRleHQ9bi5pbnB1dExhYmVsLHQuaW5zZXJ0QWRqYWNlbnRFbGVtZW50KCJiZWZvcmViZWdpbiIsaSl9fSxOZT1lPT57ZT1wW2VdfHxwLmlucHV0O3JldHVybiBQKGcoKSxlKX0sTz17fSxSZT0oTy50ZXh0PU8uZW1haWw9Ty5wYXNzd29yZD1PLm51bWJlcj1PLnRlbD1PLnVybD0oZSx0KT0+KCJzdHJpbmciPT10eXBlb2YgdC5pbnB1dFZhbHVlfHwibnVtYmVyIj09dHlwZW9mIHQuaW5wdXRWYWx1ZT9lLnZhbHVlPXQuaW5wdXRWYWx1ZTpVKHQuaW5wdXRWYWx1ZSl8fGEoJ1VuZXhwZWN0ZWQgdHlwZSBvZiBpbnB1dFZhbHVlISBFeHBlY3RlZCAic3RyaW5nIiwgIm51bWJlciIgb3IgIlByb21pc2UiLCBnb3QgIicuY29uY2F0KHR5cGVvZiB0LmlucHV0VmFsdWUsJyInKSksVmUoZSxlLHQpLEhlKGUsdCksZS50eXBlPXQuaW5wdXQsZSksTy5maWxlPShlLHQpPT4oVmUoZSxlLHQpLEhlKGUsdCksZSksTy5yYW5nZT0oZSx0KT0+e2NvbnN0IG49ZS5xdWVyeVNlbGVjdG9yKCJpbnB1dCIpLG89ZS5xdWVyeVNlbGVjdG9yKCJvdXRwdXQiKTtyZXR1cm4gbi52YWx1ZT10LmlucHV0VmFsdWUsbi50eXBlPXQuaW5wdXQsby52YWx1ZT10LmlucHV0VmFsdWUsVmUobixlLHQpLGV9LE8uc2VsZWN0PShlLHQpPT57aWYoZS50ZXh0Q29udGVudD0iIix0LmlucHV0UGxhY2Vob2xkZXIpe2NvbnN0IG49ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7eShuLHQuaW5wdXRQbGFjZWhvbGRlciksbi52YWx1ZT0iIixuLmRpc2FibGVkPSEwLG4uc2VsZWN0ZWQ9ITAsZS5hcHBlbmRDaGlsZChuKX1yZXR1cm4gVmUoZSxlLHQpLGV9LE8ucmFkaW89ZT0+KGUudGV4dENvbnRlbnQ9IiIsZSksTy5jaGVja2JveD0oZSx0KT0+e2NvbnN0IG49bGUoZygpLCJjaGVja2JveCIpO24udmFsdWU9IjEiLG4uaWQ9cC5jaGVja2JveCxuLmNoZWNrZWQ9Qm9vbGVhbih0LmlucHV0VmFsdWUpO3ZhciBvPWUucXVlcnlTZWxlY3Rvcigic3BhbiIpO3JldHVybiB5KG8sdC5pbnB1dFBsYWNlaG9sZGVyKSxlfSxPLnRleHRhcmVhPShuLGUpPT57bi52YWx1ZT1lLmlucHV0VmFsdWUsSGUobixlKSxWZShuLG4sZSk7cmV0dXJuIHNldFRpbWVvdXQoKCk9PntpZigiTXV0YXRpb25PYnNlcnZlciJpbiB3aW5kb3cpe2NvbnN0IHQ9cGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUoZygpKS53aWR0aCk7bmV3IE11dGF0aW9uT2JzZXJ2ZXIoKCk9Pnt2YXIgZT1uLm9mZnNldFdpZHRoKyhlPW4scGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUoZSkubWFyZ2luTGVmdCkrcGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUoZSkubWFyZ2luUmlnaHQpKTtlPnQ/ZygpLnN0eWxlLndpZHRoPSIiLmNvbmNhdChlLCJweCIpOmcoKS5zdHlsZS53aWR0aD1udWxsfSkub2JzZXJ2ZShuLHthdHRyaWJ1dGVzOiEwLGF0dHJpYnV0ZUZpbHRlcjpbInN0eWxlIl19KX19KSxufSwoZSx0KT0+e2NvbnN0IG49JCgpO0Mobix0LCJodG1sQ29udGFpbmVyIiksdC5odG1sPyhUZSh0Lmh0bWwsbiksQihuLCJibG9jayIpKTp0LnRleHQ/KG4udGV4dENvbnRlbnQ9dC50ZXh0LEIobiwiYmxvY2siKSk6eChuKSxJZShlLHQpfSksRmU9KGUsdCk9Pnt2YXIgbj10ZSgpO2dlKG4sdC5mb290ZXIpLHQuZm9vdGVyJiZUZSh0LmZvb3RlcixuKSxDKG4sdCwiZm9vdGVyIil9LFVlPShlLHQpPT57Y29uc3Qgbj1vZSgpO3kobix0LmNsb3NlQnV0dG9uSHRtbCksQyhuLHQsImNsb3NlQnV0dG9uIiksZ2Uobix0LnNob3dDbG9zZUJ1dHRvbiksbi5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLHQuY2xvc2VCdXR0b25BcmlhTGFiZWwpfSxXZT0oZSx0KT0+e3ZhciBlPUwuaW5uZXJQYXJhbXMuZ2V0KGUpLG49cygpO3JldHVybiBlJiZ0Lmljb249PT1lLmljb24/KFplKG4sdCksdm9pZCB6ZShuLHQpKTp0Lmljb258fHQuaWNvbkh0bWw/dC5pY29uJiYtMT09PU9iamVjdC5rZXlzKG8pLmluZGV4T2YodC5pY29uKT8obCgnVW5rbm93biBpY29uISBFeHBlY3RlZCAic3VjY2VzcyIsICJlcnJvciIsICJ3YXJuaW5nIiwgImluZm8iIG9yICJxdWVzdGlvbiIsIGdvdCAiJy5jb25jYXQodC5pY29uLCciJykpLHgobikpOihCKG4pLFplKG4sdCksemUobix0KSx2b2lkIEEobix0LnNob3dDbGFzcy5pY29uKSk6eChuKX0semU9KGUsdCk9Pntmb3IoY29uc3QgbiBpbiBvKXQuaWNvbiE9PW4mJmsoZSxvW25dKTtBKGUsb1t0Lmljb25dKSxKZShlLHQpLF9lKCksQyhlLHQsImljb24iKX0sX2U9KCk9Pntjb25zdCBlPWcoKTt2YXIgdD13aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlKS5nZXRQcm9wZXJ0eVZhbHVlKCJiYWNrZ3JvdW5kLWNvbG9yIik7Y29uc3Qgbj1lLnF1ZXJ5U2VsZWN0b3JBbGwoIltjbGFzc149c3dhbDItc3VjY2Vzcy1jaXJjdWxhci1saW5lXSwgLnN3YWwyLXN1Y2Nlc3MtZml4Iik7Zm9yKGxldCBlPTA7ZTxuLmxlbmd0aDtlKyspbltlXS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3I9dH0sS2U9J1xuICA8ZGl2IGNsYXNzPSJzd2FsMi1zdWNjZXNzLWNpcmN1bGFyLWxpbmUtbGVmdCI+PC9kaXY+XG4gIDxzcGFuIGNsYXNzPSJzd2FsMi1zdWNjZXNzLWxpbmUtdGlwIj48L3NwYW4+IDxzcGFuIGNsYXNzPSJzd2FsMi1zdWNjZXNzLWxpbmUtbG9uZyI+PC9zcGFuPlxuICA8ZGl2IGNsYXNzPSJzd2FsMi1zdWNjZXNzLXJpbmciPjwvZGl2PiA8ZGl2IGNsYXNzPSJzd2FsMi1zdWNjZXNzLWZpeCI+PC9kaXY+XG4gIDxkaXYgY2xhc3M9InN3YWwyLXN1Y2Nlc3MtY2lyY3VsYXItbGluZS1yaWdodCI+PC9kaXY+XG4nLFllPSdcbiAgPHNwYW4gY2xhc3M9InN3YWwyLXgtbWFyayI+XG4gICAgPHNwYW4gY2xhc3M9InN3YWwyLXgtbWFyay1saW5lLWxlZnQiPjwvc3Bhbj5cbiAgICA8c3BhbiBjbGFzcz0ic3dhbDIteC1tYXJrLWxpbmUtcmlnaHQiPjwvc3Bhbj5cbiAgPC9zcGFuPlxuJyxaZT0oZSx0KT0+e3ZhciBuO2UudGV4dENvbnRlbnQ9IiIsdC5pY29uSHRtbD95KGUsWGUodC5pY29uSHRtbCkpOiJzdWNjZXNzIj09PXQuaWNvbj95KGUsS2UpOiJlcnJvciI9PT10Lmljb24/eShlLFllKToobj17cXVlc3Rpb246Ij8iLHdhcm5pbmc6IiEiLGluZm86ImkifSx5KGUsWGUoblt0Lmljb25dKSkpfSxKZT0oZSx0KT0+e2lmKHQuaWNvbkNvbG9yKXtlLnN0eWxlLmNvbG9yPXQuaWNvbkNvbG9yLGUuc3R5bGUuYm9yZGVyQ29sb3I9dC5pY29uQ29sb3I7Zm9yKGNvbnN0IG4gb2ZbIi5zd2FsMi1zdWNjZXNzLWxpbmUtdGlwIiwiLnN3YWwyLXN1Y2Nlc3MtbGluZS1sb25nIiwiLnN3YWwyLXgtbWFyay1saW5lLWxlZnQiLCIuc3dhbDIteC1tYXJrLWxpbmUtcmlnaHQiXSltZShlLG4sImJhY2tncm91bmRDb2xvciIsdC5pY29uQ29sb3IpO21lKGUsIi5zd2FsMi1zdWNjZXNzLXJpbmciLCJib3JkZXJDb2xvciIsdC5pY29uQ29sb3IpfX0sWGU9ZT0+JzxkaXYgY2xhc3M9IicuY29uY2F0KHBbImljb24tY29udGVudCJdLCciPicpLmNvbmNhdChlLCI8L2Rpdj4iKSwkZT0oZSx0KT0+e2NvbnN0IG49RygpO2lmKCF0LmltYWdlVXJsKXJldHVybiB4KG4pO0IobiwiIiksbi5zZXRBdHRyaWJ1dGUoInNyYyIsdC5pbWFnZVVybCksbi5zZXRBdHRyaWJ1dGUoImFsdCIsdC5pbWFnZUFsdCkscGUobiwid2lkdGgiLHQuaW1hZ2VXaWR0aCkscGUobiwiaGVpZ2h0Iix0LmltYWdlSGVpZ2h0KSxuLmNsYXNzTmFtZT1wLmltYWdlLEMobix0LCJpbWFnZSIpfSxHZT0oZSxvKT0+e2NvbnN0IGk9USgpO2lmKCFvLnByb2dyZXNzU3RlcHN8fDA9PT1vLnByb2dyZXNzU3RlcHMubGVuZ3RoKXJldHVybiB4KGkpO0IoaSksaS50ZXh0Q29udGVudD0iIixvLmN1cnJlbnRQcm9ncmVzc1N0ZXA+PW8ucHJvZ3Jlc3NTdGVwcy5sZW5ndGgmJmEoIkludmFsaWQgY3VycmVudFByb2dyZXNzU3RlcCBwYXJhbWV0ZXIsIGl0IHNob3VsZCBiZSBsZXNzIHRoYW4gcHJvZ3Jlc3NTdGVwcy5sZW5ndGggKGN1cnJlbnRQcm9ncmVzc1N0ZXAgbGlrZSBKUyBhcnJheXMgc3RhcnRzIGZyb20gMCkiKSxvLnByb2dyZXNzU3RlcHMuZm9yRWFjaCgoZSx0KT0+e2U9ZSxuPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIiksQShuLHBbInByb2dyZXNzLXN0ZXAiXSkseShuLGUpO3ZhciBuLGU9bjtpLmFwcGVuZENoaWxkKGUpLHQ9PT1vLmN1cnJlbnRQcm9ncmVzc1N0ZXAmJkEoZSxwWyJhY3RpdmUtcHJvZ3Jlc3Mtc3RlcCJdKSx0IT09by5wcm9ncmVzc1N0ZXBzLmxlbmd0aC0xJiYobj0oZT0+e2NvbnN0IHQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTtyZXR1cm4gQSh0LHBbInByb2dyZXNzLXN0ZXAtbGluZSJdKSxlLnByb2dyZXNzU3RlcHNEaXN0YW5jZSYmKHQuc3R5bGUud2lkdGg9ZS5wcm9ncmVzc1N0ZXBzRGlzdGFuY2UpLHR9KShvKSxpLmFwcGVuZENoaWxkKG4pKX0pfSxRZT0oZSx0KT0+e2NvbnN0IG49WCgpO2dlKG4sdC50aXRsZXx8dC50aXRsZVRleHQsImJsb2NrIiksdC50aXRsZSYmVGUodC50aXRsZSxuKSx0LnRpdGxlVGV4dCYmKG4uaW5uZXJUZXh0PXQudGl0bGVUZXh0KSxDKG4sdCwidGl0bGUiKX0sZXQ9KGUsdCk9Pnt2YXIgbj1tKCk7Y29uc3Qgbz1nKCk7dC50b2FzdD8ocGUobiwid2lkdGgiLHQud2lkdGgpLG8uc3R5bGUud2lkdGg9IjEwMCUiLG8uaW5zZXJ0QmVmb3JlKGQoKSxzKCkpKTpwZShvLCJ3aWR0aCIsdC53aWR0aCkscGUobywicGFkZGluZyIsdC5wYWRkaW5nKSx0LmNvbG9yJiYoby5zdHlsZS5jb2xvcj10LmNvbG9yKSx0LmJhY2tncm91bmQmJihvLnN0eWxlLmJhY2tncm91bmQ9dC5iYWNrZ3JvdW5kKSx4KGVlKCkpO249bzsobi5jbGFzc05hbWU9IiIuY29uY2F0KHAucG9wdXAsIiAiKS5jb25jYXQoRShuKT90LnNob3dDbGFzcy5wb3B1cDoiIiksdC50b2FzdCk/KEEoW2RvY3VtZW50LmRvY3VtZW50RWxlbWVudCxkb2N1bWVudC5ib2R5XSxwWyJ0b2FzdC1zaG93biJdKSxBKG4scC50b2FzdCkpOkEobixwLm1vZGFsKTtDKG4sdCwicG9wdXAiKSwic3RyaW5nIj09dHlwZW9mIHQuY3VzdG9tQ2xhc3MmJkEobix0LmN1c3RvbUNsYXNzKTt0Lmljb24mJkEobixwWyJpY29uLSIuY29uY2F0KHQuaWNvbildKX0sdHQ9KGUsdCk9PntldChlLHQpLE1lKGUsdCksR2UoZSx0KSxXZShlLHQpLCRlKGUsdCksUWUoZSx0KSxVZShlLHQpLFJlKGUsdCksT2UoZSx0KSxGZShlLHQpLCJmdW5jdGlvbiI9PXR5cGVvZiB0LmRpZFJlbmRlciYmdC5kaWRSZW5kZXIoZygpKX0saj1PYmplY3QuZnJlZXplKHtjYW5jZWw6ImNhbmNlbCIsYmFja2Ryb3A6ImJhY2tkcm9wIixjbG9zZToiY2xvc2UiLGVzYzoiZXNjIix0aW1lcjoidGltZXIifSksbnQ9KCk9Pntjb25zdCBlPWkoZG9jdW1lbnQuYm9keS5jaGlsZHJlbik7ZS5mb3JFYWNoKGU9PntlPT09bSgpfHxlLmNvbnRhaW5zKG0oKSl8fChlLmhhc0F0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iKSYmZS5zZXRBdHRyaWJ1dGUoImRhdGEtcHJldmlvdXMtYXJpYS1oaWRkZW4iLGUuZ2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIpKSxlLnNldEF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iLCJ0cnVlIikpfSl9LG90PSgpPT57Y29uc3QgZT1pKGRvY3VtZW50LmJvZHkuY2hpbGRyZW4pO2UuZm9yRWFjaChlPT57ZS5oYXNBdHRyaWJ1dGUoImRhdGEtcHJldmlvdXMtYXJpYS1oaWRkZW4iKT8oZS5zZXRBdHRyaWJ1dGUoImFyaWEtaGlkZGVuIixlLmdldEF0dHJpYnV0ZSgiZGF0YS1wcmV2aW91cy1hcmlhLWhpZGRlbiIpKSxlLnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1wcmV2aW91cy1hcmlhLWhpZGRlbiIpKTplLnJlbW92ZUF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iKX0pfSxpdD1bInN3YWwtdGl0bGUiLCJzd2FsLWh0bWwiLCJzd2FsLWZvb3RlciJdLGF0PWU9Pntjb25zdCBuPXt9O3JldHVybiBpKGUucXVlcnlTZWxlY3RvckFsbCgic3dhbC1wYXJhbSIpKS5mb3JFYWNoKGU9PntNKGUsWyJuYW1lIiwidmFsdWUiXSk7dmFyIHQ9ZS5nZXRBdHRyaWJ1dGUoIm5hbWUiKSxlPWUuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpOyJib29sZWFuIj09dHlwZW9mIHJbdF0mJiJmYWxzZSI9PT1lJiYoblt0XT0hMSksIm9iamVjdCI9PXR5cGVvZiByW3RdJiYoblt0XT1KU09OLnBhcnNlKGUpKX0pLG59LHJ0PWU9Pntjb25zdCBuPXt9O3JldHVybiBpKGUucXVlcnlTZWxlY3RvckFsbCgic3dhbC1idXR0b24iKSkuZm9yRWFjaChlPT57TShlLFsidHlwZSIsImNvbG9yIiwiYXJpYS1sYWJlbCJdKTt2YXIgdD1lLmdldEF0dHJpYnV0ZSgidHlwZSIpO25bIiIuY29uY2F0KHQsIkJ1dHRvblRleHQiKV09ZS5pbm5lckhUTUwsblsic2hvdyIuY29uY2F0KEgodCksIkJ1dHRvbiIpXT0hMCxlLmhhc0F0dHJpYnV0ZSgiY29sb3IiKSYmKG5bIiIuY29uY2F0KHQsIkJ1dHRvbkNvbG9yIildPWUuZ2V0QXR0cmlidXRlKCJjb2xvciIpKSxlLmhhc0F0dHJpYnV0ZSgiYXJpYS1sYWJlbCIpJiYoblsiIi5jb25jYXQodCwiQnV0dG9uQXJpYUxhYmVsIildPWUuZ2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIikpfSksbn0sc3Q9ZT0+e2NvbnN0IHQ9e30sbj1lLnF1ZXJ5U2VsZWN0b3IoInN3YWwtaW1hZ2UiKTtyZXR1cm4gbiYmKE0obixbInNyYyIsIndpZHRoIiwiaGVpZ2h0IiwiYWx0Il0pLG4uaGFzQXR0cmlidXRlKCJzcmMiKSYmKHQuaW1hZ2VVcmw9bi5nZXRBdHRyaWJ1dGUoInNyYyIpKSxuLmhhc0F0dHJpYnV0ZSgid2lkdGgiKSYmKHQuaW1hZ2VXaWR0aD1uLmdldEF0dHJpYnV0ZSgid2lkdGgiKSksbi5oYXNBdHRyaWJ1dGUoImhlaWdodCIpJiYodC5pbWFnZUhlaWdodD1uLmdldEF0dHJpYnV0ZSgiaGVpZ2h0IikpLG4uaGFzQXR0cmlidXRlKCJhbHQiKSYmKHQuaW1hZ2VBbHQ9bi5nZXRBdHRyaWJ1dGUoImFsdCIpKSksdH0sY3Q9ZT0+e2NvbnN0IHQ9e30sbj1lLnF1ZXJ5U2VsZWN0b3IoInN3YWwtaWNvbiIpO3JldHVybiBuJiYoTShuLFsidHlwZSIsImNvbG9yIl0pLG4uaGFzQXR0cmlidXRlKCJ0eXBlIikmJih0Lmljb249bi5nZXRBdHRyaWJ1dGUoInR5cGUiKSksbi5oYXNBdHRyaWJ1dGUoImNvbG9yIikmJih0Lmljb25Db2xvcj1uLmdldEF0dHJpYnV0ZSgiY29sb3IiKSksdC5pY29uSHRtbD1uLmlubmVySFRNTCksdH0sbHQ9ZT0+e2NvbnN0IG49e30sdD1lLnF1ZXJ5U2VsZWN0b3IoInN3YWwtaW5wdXQiKTt0JiYoTSh0LFsidHlwZSIsImxhYmVsIiwicGxhY2Vob2xkZXIiLCJ2YWx1ZSJdKSxuLmlucHV0PXQuZ2V0QXR0cmlidXRlKCJ0eXBlIil8fCJ0ZXh0Iix0Lmhhc0F0dHJpYnV0ZSgibGFiZWwiKSYmKG4uaW5wdXRMYWJlbD10LmdldEF0dHJpYnV0ZSgibGFiZWwiKSksdC5oYXNBdHRyaWJ1dGUoInBsYWNlaG9sZGVyIikmJihuLmlucHV0UGxhY2Vob2xkZXI9dC5nZXRBdHRyaWJ1dGUoInBsYWNlaG9sZGVyIikpLHQuaGFzQXR0cmlidXRlKCJ2YWx1ZSIpJiYobi5pbnB1dFZhbHVlPXQuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpKSk7ZT1lLnF1ZXJ5U2VsZWN0b3JBbGwoInN3YWwtaW5wdXQtb3B0aW9uIik7cmV0dXJuIGUubGVuZ3RoJiYobi5pbnB1dE9wdGlvbnM9e30saShlKS5mb3JFYWNoKGU9PntNKGUsWyJ2YWx1ZSJdKTt2YXIgdD1lLmdldEF0dHJpYnV0ZSgidmFsdWUiKSxlPWUuaW5uZXJIVE1MO24uaW5wdXRPcHRpb25zW3RdPWV9KSksbn0sdXQ9KGUsdCk9Pntjb25zdCBuPXt9O2Zvcihjb25zdCBvIGluIHQpe2NvbnN0IGk9dFtvXSxhPWUucXVlcnlTZWxlY3RvcihpKTthJiYoTShhLFtdKSxuW2kucmVwbGFjZSgvXnN3YWwtLywiIildPWEuaW5uZXJIVE1MLnRyaW0oKSl9cmV0dXJuIG59LGR0PWU9Pntjb25zdCB0PWl0LmNvbmNhdChbInN3YWwtcGFyYW0iLCJzd2FsLWJ1dHRvbiIsInN3YWwtaW1hZ2UiLCJzd2FsLWljb24iLCJzd2FsLWlucHV0Iiwic3dhbC1pbnB1dC1vcHRpb24iXSk7aShlLmNoaWxkcmVuKS5mb3JFYWNoKGU9PntlPWUudGFnTmFtZS50b0xvd2VyQ2FzZSgpOy0xPT09dC5pbmRleE9mKGUpJiZhKCJVbnJlY29nbml6ZWQgZWxlbWVudCA8Ii5jb25jYXQoZSwiPiIpKX0pfSxNPSh0LG4pPT57aSh0LmF0dHJpYnV0ZXMpLmZvckVhY2goZT0+ey0xPT09bi5pbmRleE9mKGUubmFtZSkmJmEoWydVbnJlY29nbml6ZWQgYXR0cmlidXRlICInLmNvbmNhdChlLm5hbWUsJyIgb24gPCcpLmNvbmNhdCh0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSwiPi4iKSwiIi5jb25jYXQobi5sZW5ndGg/IkFsbG93ZWQgYXR0cmlidXRlcyBhcmU6ICIuY29uY2F0KG4uam9pbigiLCAiKSk6IlRvIHNldCB0aGUgdmFsdWUsIHVzZSBIVE1MIHdpdGhpbiB0aGUgZWxlbWVudC4iKV0pfSl9O3ZhciBwdD17ZW1haWw6KGUsdCk9Pi9eW2EtekEtWjAtOS4rXy1dK0BbYS16QS1aMC05Li1dK1wuW2EtekEtWjAtOS1dezIsMjR9JC8udGVzdChlKT9Qcm9taXNlLnJlc29sdmUoKTpQcm9taXNlLnJlc29sdmUodHx8IkludmFsaWQgZW1haWwgYWRkcmVzcyIpLHVybDooZSx0KT0+L15odHRwcz86XC9cLyh3d3dcLik/Wy1hLXpBLVowLTlAOiUuXyt+Iz1dezEsMjU2fVwuW2Etel17Miw2M31cYihbLWEtekEtWjAtOUA6JV8rLn4jPyYvPV0qKSQvLnRlc3QoZSk/UHJvbWlzZS5yZXNvbHZlKCk6UHJvbWlzZS5yZXNvbHZlKHR8fCJJbnZhbGlkIFVSTCIpfTtmdW5jdGlvbiBtdChlKXsodD1lKS5pbnB1dFZhbGlkYXRvcnx8T2JqZWN0LmtleXMocHQpLmZvckVhY2goZT0+e3QuaW5wdXQ9PT1lJiYodC5pbnB1dFZhbGlkYXRvcj1wdFtlXSl9KSxlLnNob3dMb2FkZXJPbkNvbmZpcm0mJiFlLnByZUNvbmZpcm0mJmEoInNob3dMb2FkZXJPbkNvbmZpcm0gaXMgc2V0IHRvIHRydWUsIGJ1dCBwcmVDb25maXJtIGlzIG5vdCBkZWZpbmVkLlxuc2hvd0xvYWRlck9uQ29uZmlybSBzaG91bGQgYmUgdXNlZCB0b2dldGhlciB3aXRoIHByZUNvbmZpcm0sIHNlZSB1c2FnZSBleGFtcGxlOlxuaHR0cHM6Ly9zd2VldGFsZXJ0Mi5naXRodWIuaW8vI2FqYXgtcmVxdWVzdCIpLChuPWUpLnRhcmdldCYmKCJzdHJpbmciIT10eXBlb2Ygbi50YXJnZXR8fGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iobi50YXJnZXQpKSYmKCJzdHJpbmciPT10eXBlb2Ygbi50YXJnZXR8fG4udGFyZ2V0LmFwcGVuZENoaWxkKXx8KGEoJ1RhcmdldCBwYXJhbWV0ZXIgaXMgbm90IHZhbGlkLCBkZWZhdWx0aW5nIHRvICJib2R5IicpLG4udGFyZ2V0PSJib2R5IiksInN0cmluZyI9PXR5cGVvZiBlLnRpdGxlJiYoZS50aXRsZT1lLnRpdGxlLnNwbGl0KCJcbiIpLmpvaW4oIjxiciAvPiIpKTt2YXIgdCxuPWUsZT1rZSgpO2lmKHZlKCkpbCgiU3dlZXRBbGVydDIgcmVxdWlyZXMgZG9jdW1lbnQgdG8gaW5pdGlhbGl6ZSIpO2Vsc2V7Y29uc3Qgbz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSxpPShvLmNsYXNzTmFtZT1wLmNvbnRhaW5lcixlJiZBKG8scFsibm8tdHJhbnNpdGlvbiJdKSx5KG8sQWUpLEJlKG4udGFyZ2V0KSk7aS5hcHBlbmRDaGlsZChvKSx4ZShuKSxFZShpKSxQZSgpfX1jbGFzcyBndHtjb25zdHJ1Y3RvcihlLHQpe3RoaXMuY2FsbGJhY2s9ZSx0aGlzLnJlbWFpbmluZz10LHRoaXMucnVubmluZz0hMSx0aGlzLnN0YXJ0KCl9c3RhcnQoKXtyZXR1cm4gdGhpcy5ydW5uaW5nfHwodGhpcy5ydW5uaW5nPSEwLHRoaXMuc3RhcnRlZD1uZXcgRGF0ZSx0aGlzLmlkPXNldFRpbWVvdXQodGhpcy5jYWxsYmFjayx0aGlzLnJlbWFpbmluZykpLHRoaXMucmVtYWluaW5nfXN0b3AoKXtyZXR1cm4gdGhpcy5ydW5uaW5nJiYodGhpcy5ydW5uaW5nPSExLGNsZWFyVGltZW91dCh0aGlzLmlkKSx0aGlzLnJlbWFpbmluZy09KG5ldyBEYXRlKS5nZXRUaW1lKCktdGhpcy5zdGFydGVkLmdldFRpbWUoKSksdGhpcy5yZW1haW5pbmd9aW5jcmVhc2UoZSl7dmFyIHQ9dGhpcy5ydW5uaW5nO3JldHVybiB0JiZ0aGlzLnN0b3AoKSx0aGlzLnJlbWFpbmluZys9ZSx0JiZ0aGlzLnN0YXJ0KCksdGhpcy5yZW1haW5pbmd9Z2V0VGltZXJMZWZ0KCl7cmV0dXJuIHRoaXMucnVubmluZyYmKHRoaXMuc3RvcCgpLHRoaXMuc3RhcnQoKSksdGhpcy5yZW1haW5pbmd9aXNSdW5uaW5nKCl7cmV0dXJuIHRoaXMucnVubmluZ319Y29uc3QgaHQ9KCk9PntudWxsPT09Yy5wcmV2aW91c0JvZHlQYWRkaW5nJiZkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodD53aW5kb3cuaW5uZXJIZWlnaHQmJihjLnByZXZpb3VzQm9keVBhZGRpbmc9cGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSkuZ2V0UHJvcGVydHlWYWx1ZSgicGFkZGluZy1yaWdodCIpKSxkb2N1bWVudC5ib2R5LnN0eWxlLnBhZGRpbmdSaWdodD0iIi5jb25jYXQoYy5wcmV2aW91c0JvZHlQYWRkaW5nKygoKT0+e2NvbnN0IGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7ZS5jbGFzc05hbWU9cFsic2Nyb2xsYmFyLW1lYXN1cmUiXSxkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpO3ZhciB0PWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGgtZS5jbGllbnRXaWR0aDtyZXR1cm4gZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlKSx0fSkoKSwicHgiKSl9LGZ0PSgpPT57bnVsbCE9PWMucHJldmlvdXNCb2R5UGFkZGluZyYmKGRvY3VtZW50LmJvZHkuc3R5bGUucGFkZGluZ1JpZ2h0PSIiLmNvbmNhdChjLnByZXZpb3VzQm9keVBhZGRpbmcsInB4IiksYy5wcmV2aW91c0JvZHlQYWRkaW5nPW51bGwpfSxidD0oKT0+e2lmKCgvaVBhZHxpUGhvbmV8aVBvZC8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSYmIXdpbmRvdy5NU1N0cmVhbXx8Ik1hY0ludGVsIj09PW5hdmlnYXRvci5wbGF0Zm9ybSYmMTxuYXZpZ2F0b3IubWF4VG91Y2hQb2ludHMpJiYhdyhkb2N1bWVudC5ib2R5LHAuaW9zZml4KSl7dmFyIGUsdD1kb2N1bWVudC5ib2R5LnNjcm9sbFRvcDtkb2N1bWVudC5ib2R5LnN0eWxlLnRvcD0iIi5jb25jYXQoLTEqdCwicHgiKSxBKGRvY3VtZW50LmJvZHkscC5pb3NmaXgpO3tjb25zdCBuPW0oKTtsZXQgdDtuLm9udG91Y2hzdGFydD1lPT57dD12dChlKX0sbi5vbnRvdWNobW92ZT1lPT57dCYmKGUucHJldmVudERlZmF1bHQoKSxlLnN0b3BQcm9wYWdhdGlvbigpKX19e2NvbnN0IG89bmF2aWdhdG9yLnVzZXJBZ2VudCxpPSEhby5tYXRjaCgvaVBhZC9pKXx8ISFvLm1hdGNoKC9pUGhvbmUvaSksYT0hIW8ubWF0Y2goL1dlYktpdC9pKSxyPWkmJmEmJiFvLm1hdGNoKC9DcmlPUy9pKTtyJiYoZT00NCxnKCkuc2Nyb2xsSGVpZ2h0PndpbmRvdy5pbm5lckhlaWdodC00NCYmKG0oKS5zdHlsZS5wYWRkaW5nQm90dG9tPSIiLmNvbmNhdCg0NCwicHgiKSkpfX19LHZ0PWU9Pnt2YXIgdCxuPWUudGFyZ2V0LG89bSgpO3JldHVybiEoKHQ9ZSkudG91Y2hlcyYmdC50b3VjaGVzLmxlbmd0aCYmInN0eWx1cyI9PT10LnRvdWNoZXNbMF0udG91Y2hUeXBlfHwodD1lKS50b3VjaGVzJiYxPHQudG91Y2hlcy5sZW5ndGgpJiYobj09PW98fCEoZmUobyl8fCJJTlBVVCI9PT1uLnRhZ05hbWV8fCJURVhUQVJFQSI9PT1uLnRhZ05hbWV8fGZlKCQoKSkmJiQoKS5jb250YWlucyhuKSkpfSx5dD0oKT0+e3ZhciBlO3coZG9jdW1lbnQuYm9keSxwLmlvc2ZpeCkmJihlPXBhcnNlSW50KGRvY3VtZW50LmJvZHkuc3R5bGUudG9wLDEwKSxrKGRvY3VtZW50LmJvZHkscC5pb3NmaXgpLGRvY3VtZW50LmJvZHkuc3R5bGUudG9wPSIiLGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wPS0xKmUpfSx3dD0xMCxDdD1lPT57Y29uc3QgdD1nKCk7aWYoZS50YXJnZXQ9PT10KXtjb25zdCBuPW0oKTt0LnJlbW92ZUV2ZW50TGlzdGVuZXIoTGUsQ3QpLG4uc3R5bGUub3ZlcmZsb3dZPSJhdXRvIn19LEF0PShlLHQpPT57TGUmJmJlKHQpPyhlLnN0eWxlLm92ZXJmbG93WT0iaGlkZGVuIix0LmFkZEV2ZW50TGlzdGVuZXIoTGUsQ3QpKTplLnN0eWxlLm92ZXJmbG93WT0iYXV0byJ9LGt0PShlLHQsbik9PntidCgpLHQmJiJoaWRkZW4iIT09biYmaHQoKSxzZXRUaW1lb3V0KCgpPT57ZS5zY3JvbGxUb3A9MH0pfSxQdD0oZSx0LG4pPT57QShlLG4uc2hvd0NsYXNzLmJhY2tkcm9wKSx0LnN0eWxlLnNldFByb3BlcnR5KCJvcGFjaXR5IiwiMCIsImltcG9ydGFudCIpLEIodCwiZ3JpZCIpLHNldFRpbWVvdXQoKCk9PntBKHQsbi5zaG93Q2xhc3MucG9wdXApLHQuc3R5bGUucmVtb3ZlUHJvcGVydHkoIm9wYWNpdHkiKX0sd3QpLEEoW2RvY3VtZW50LmRvY3VtZW50RWxlbWVudCxkb2N1bWVudC5ib2R5XSxwLnNob3duKSxuLmhlaWdodEF1dG8mJm4uYmFja2Ryb3AmJiFuLnRvYXN0JiZBKFtkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsZG9jdW1lbnQuYm9keV0scFsiaGVpZ2h0LWF1dG8iXSl9LEQ9ZT0+e2xldCB0PWcoKTt0fHxuZXcgd24sdD1nKCk7dmFyIG49ZCgpO2lmKHJlKCkpeChzKCkpO2Vsc2V7dmFyIG89dDtjb25zdCBpPXYoKSxhPWQoKTshZSYmRShoKCkpJiYoZT1oKCkpO0IoaSksZSYmKHgoZSksYS5zZXRBdHRyaWJ1dGUoImRhdGEtYnV0dG9uLXRvLXJlcGxhY2UiLGUuY2xhc3NOYW1lKSk7YS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLGUpLEEoW28saV0scC5sb2FkaW5nKX1CKG4pLHQuc2V0QXR0cmlidXRlKCJkYXRhLWxvYWRpbmciLCEwKSx0LnNldEF0dHJpYnV0ZSgiYXJpYS1idXN5IiwhMCksdC5mb2N1cygpfSxCdD0odCxuKT0+e2NvbnN0IG89ZygpLGk9ZT0+RXRbbi5pbnB1dF0obyxUdChlKSxuKTtGKG4uaW5wdXRPcHRpb25zKXx8VShuLmlucHV0T3B0aW9ucyk/KEQoaCgpKSx1KG4uaW5wdXRPcHRpb25zKS50aGVuKGU9Pnt0LmhpZGVMb2FkaW5nKCksaShlKX0pKToib2JqZWN0Ij09dHlwZW9mIG4uaW5wdXRPcHRpb25zP2kobi5pbnB1dE9wdGlvbnMpOmwoIlVuZXhwZWN0ZWQgdHlwZSBvZiBpbnB1dE9wdGlvbnMhIEV4cGVjdGVkIG9iamVjdCwgTWFwIG9yIFByb21pc2UsIGdvdCAiLmNvbmNhdCh0eXBlb2Ygbi5pbnB1dE9wdGlvbnMpKX0seHQ9KHQsbik9Pntjb25zdCBvPXQuZ2V0SW5wdXQoKTt4KG8pLHUobi5pbnB1dFZhbHVlKS50aGVuKGU9PntvLnZhbHVlPSJudW1iZXIiPT09bi5pbnB1dD9wYXJzZUZsb2F0KGUpfHwwOiIiLmNvbmNhdChlKSxCKG8pLG8uZm9jdXMoKSx0LmhpZGVMb2FkaW5nKCl9KS5jYXRjaChlPT57bCgiRXJyb3IgaW4gaW5wdXRWYWx1ZSBwcm9taXNlOiAiLmNvbmNhdChlKSksby52YWx1ZT0iIixCKG8pLG8uZm9jdXMoKSx0LmhpZGVMb2FkaW5nKCl9KX0sRXQ9e3NlbGVjdDooZSx0LGkpPT57Y29uc3QgYT1QKGUscC5zZWxlY3QpLHI9KGUsdCxuKT0+e2NvbnN0IG89ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7by52YWx1ZT1uLHkobyx0KSxvLnNlbGVjdGVkPVN0KG4saS5pbnB1dFZhbHVlKSxlLmFwcGVuZENoaWxkKG8pfTt0LmZvckVhY2goZT0+e3ZhciB0PWVbMF07Y29uc3Qgbj1lWzFdO2lmKEFycmF5LmlzQXJyYXkobikpe2NvbnN0IG89ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0Z3JvdXAiKTtvLmxhYmVsPXQsby5kaXNhYmxlZD0hMSxhLmFwcGVuZENoaWxkKG8pLG4uZm9yRWFjaChlPT5yKG8sZVsxXSxlWzBdKSl9ZWxzZSByKGEsbix0KX0pLGEuZm9jdXMoKX0scmFkaW86KGUsdCxhKT0+e2NvbnN0IHI9UChlLHAucmFkaW8pLG49KHQuZm9yRWFjaChlPT57dmFyIHQ9ZVswXSxlPWVbMV07Y29uc3Qgbj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpLG89ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKSxpPShuLnR5cGU9InJhZGlvIixuLm5hbWU9cC5yYWRpbyxuLnZhbHVlPXQsU3QodCxhLmlucHV0VmFsdWUpJiYobi5jaGVja2VkPSEwKSxkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIikpO3koaSxlKSxpLmNsYXNzTmFtZT1wLmxhYmVsLG8uYXBwZW5kQ2hpbGQobiksby5hcHBlbmRDaGlsZChpKSxyLmFwcGVuZENoaWxkKG8pfSksci5xdWVyeVNlbGVjdG9yQWxsKCJpbnB1dCIpKTtuLmxlbmd0aCYmblswXS5mb2N1cygpfX0sVHQ9bj0+e2NvbnN0IG89W107cmV0dXJuInVuZGVmaW5lZCIhPXR5cGVvZiBNYXAmJm4gaW5zdGFuY2VvZiBNYXA/bi5mb3JFYWNoKChlLHQpPT57bGV0IG49ZTsib2JqZWN0Ij09dHlwZW9mIG4mJihuPVR0KG4pKSxvLnB1c2goW3Qsbl0pfSk6T2JqZWN0LmtleXMobikuZm9yRWFjaChlPT57bGV0IHQ9bltlXTsib2JqZWN0Ij09dHlwZW9mIHQmJih0PVR0KHQpKSxvLnB1c2goW2UsdF0pfSksb30sU3Q9KGUsdCk9PnQmJnQudG9TdHJpbmcoKT09PWUudG9TdHJpbmcoKTtmdW5jdGlvbiBMdCgpe3ZhciBlLHQ9TC5pbm5lclBhcmFtcy5nZXQodGhpcyk7aWYodCl7Y29uc3Qgbj1MLmRvbUNhY2hlLmdldCh0aGlzKTt4KG4ubG9hZGVyKSxyZSgpP3QuaWNvbiYmQihzKCkpOih0PW4sKGU9dC5wb3B1cC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHQubG9hZGVyLmdldEF0dHJpYnV0ZSgiZGF0YS1idXR0b24tdG8tcmVwbGFjZSIpKSkubGVuZ3RoP0IoZVswXSwiaW5saW5lLWJsb2NrIik6aGUoKSYmeCh0LmFjdGlvbnMpKSxrKFtuLnBvcHVwLG4uYWN0aW9uc10scC5sb2FkaW5nKSxuLnBvcHVwLnJlbW92ZUF0dHJpYnV0ZSgiYXJpYS1idXN5Iiksbi5wb3B1cC5yZW1vdmVBdHRyaWJ1dGUoImRhdGEtbG9hZGluZyIpLG4uY29uZmlybUJ1dHRvbi5kaXNhYmxlZD0hMSxuLmRlbnlCdXR0b24uZGlzYWJsZWQ9ITEsbi5jYW5jZWxCdXR0b24uZGlzYWJsZWQ9ITF9fXZhciBPdD17c3dhbFByb21pc2VSZXNvbHZlOm5ldyBXZWFrTWFwLHN3YWxQcm9taXNlUmVqZWN0Om5ldyBXZWFrTWFwfTtjb25zdCBqdD0oKT0+aCgpJiZoKCkuY2xpY2soKTtjb25zdCBNdD1lPT57ZS5rZXlkb3duVGFyZ2V0JiZlLmtleWRvd25IYW5kbGVyQWRkZWQmJihlLmtleWRvd25UYXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsZS5rZXlkb3duSGFuZGxlcix7Y2FwdHVyZTplLmtleWRvd25MaXN0ZW5lckNhcHR1cmV9KSxlLmtleWRvd25IYW5kbGVyQWRkZWQ9ITEpfSxEdD0oZSx0LG4pPT57Y29uc3Qgbz1pZSgpO2lmKG8ubGVuZ3RoKXJldHVybih0Kz1uKT09PW8ubGVuZ3RoP3Q9MDotMT09PXQmJih0PW8ubGVuZ3RoLTEpLG9bdF0uZm9jdXMoKTtnKCkuZm9jdXMoKX0sSXQ9WyJBcnJvd1JpZ2h0IiwiQXJyb3dEb3duIl0scXQ9WyJBcnJvd0xlZnQiLCJBcnJvd1VwIl0sSHQ9KGUsbix0KT0+e3ZhciBvPUwuaW5uZXJQYXJhbXMuZ2V0KGUpO2lmKG8mJighbi5pc0NvbXBvc2luZyYmMjI5IT09bi5rZXlDb2RlKSlpZihvLnN0b3BLZXlkb3duUHJvcGFnYXRpb24mJm4uc3RvcFByb3BhZ2F0aW9uKCksIkVudGVyIj09PW4ua2V5KWU9ZSxzPW4saT1vLFIoaS5hbGxvd0VudGVyS2V5KSYmcy50YXJnZXQmJmUuZ2V0SW5wdXQoKSYmcy50YXJnZXQub3V0ZXJIVE1MPT09ZS5nZXRJbnB1dCgpLm91dGVySFRNTCYmKFsidGV4dGFyZWEiLCJmaWxlIl0uaW5jbHVkZXMoaS5pbnB1dCl8fChqdCgpLHMucHJldmVudERlZmF1bHQoKSkpO2Vsc2UgaWYoIlRhYiI9PT1uLmtleSl7ZT1uO3ZhciBpPW87dmFyIGE9ZS50YXJnZXQscj1pZSgpO2xldCB0PS0xO2ZvcihsZXQgZT0wO2U8ci5sZW5ndGg7ZSsrKWlmKGE9PT1yW2VdKXt0PWU7YnJlYWt9ZS5zaGlmdEtleT9EdChpLHQsLTEpOkR0KGksdCwxKTtlLnN0b3BQcm9wYWdhdGlvbigpLGUucHJldmVudERlZmF1bHQoKX1lbHNlIGlmKFsuLi5JdCwuLi5xdF0uaW5jbHVkZXMobi5rZXkpKXt2YXIgcz1uLmtleTtjb25zdCBsPWgoKSx1PWYoKSxkPWIoKTtpZihbbCx1LGRdLmluY2x1ZGVzKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKXt2YXIgYz1JdC5pbmNsdWRlcyhzKT8ibmV4dEVsZW1lbnRTaWJsaW5nIjoicHJldmlvdXNFbGVtZW50U2libGluZyI7bGV0IHQ9ZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtmb3IobGV0IGU9MDtlPHYoKS5jaGlsZHJlbi5sZW5ndGg7ZSsrKXtpZighKHQ9dFtjXSkpcmV0dXJuO2lmKEUodCkmJnQgaW5zdGFuY2VvZiBIVE1MQnV0dG9uRWxlbWVudClicmVha310IGluc3RhbmNlb2YgSFRNTEJ1dHRvbkVsZW1lbnQmJnQuZm9jdXMoKX19ZWxzZSBpZigiRXNjYXBlIj09PW4ua2V5KXtlPW4sbj1vLG89dDtpZihSKG4uYWxsb3dFc2NhcGVLZXkpKXtlLnByZXZlbnREZWZhdWx0KCk7byhqLmVzYyl9fX07ZnVuY3Rpb24gVnQoZSx0LG4sbyl7cmUoKT9VdChlLG8pOihDZShuKS50aGVuKCgpPT5VdChlLG8pKSxNdChUKSksL14oKD8hY2hyb21lfGFuZHJvaWQpLikqc2FmYXJpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KT8odC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwiZGlzcGxheTpub25lICFpbXBvcnRhbnQiKSx0LnJlbW92ZUF0dHJpYnV0ZSgiY2xhc3MiKSx0LmlubmVySFRNTD0iIik6dC5yZW1vdmUoKSxhZSgpJiYoZnQoKSx5dCgpLG90KCkpLGsoW2RvY3VtZW50LmRvY3VtZW50RWxlbWVudCxkb2N1bWVudC5ib2R5XSxbcC5zaG93bixwWyJoZWlnaHQtYXV0byJdLHBbIm5vLWJhY2tkcm9wIl0scFsidG9hc3Qtc2hvd24iXV0pfWZ1bmN0aW9uIE50KGUpe2U9dm9pZCAwIT09KG49ZSk/T2JqZWN0LmFzc2lnbih7aXNDb25maXJtZWQ6ITEsaXNEZW5pZWQ6ITEsaXNEaXNtaXNzZWQ6ITF9LG4pOntpc0NvbmZpcm1lZDohMSxpc0RlbmllZDohMSxpc0Rpc21pc3NlZDohMH07Y29uc3QgdD1PdC5zd2FsUHJvbWlzZVJlc29sdmUuZ2V0KHRoaXMpO3ZhciBuPShlPT57Y29uc3QgdD1nKCk7aWYoIXQpcmV0dXJuIGZhbHNlO2NvbnN0IG49TC5pbm5lclBhcmFtcy5nZXQoZSk7aWYoIW58fHcodCxuLmhpZGVDbGFzcy5wb3B1cCkpcmV0dXJuIGZhbHNlO2sodCxuLnNob3dDbGFzcy5wb3B1cCksQSh0LG4uaGlkZUNsYXNzLnBvcHVwKTtjb25zdCBvPW0oKTtyZXR1cm4gayhvLG4uc2hvd0NsYXNzLmJhY2tkcm9wKSxBKG8sbi5oaWRlQ2xhc3MuYmFja2Ryb3ApLEZ0KGUsdCxuKSx0cnVlfSkodGhpcyk7dGhpcy5pc0F3YWl0aW5nUHJvbWlzZSgpP2UuaXNEaXNtaXNzZWR8fChSdCh0aGlzKSx0KGUpKTpuJiZ0KGUpfWNvbnN0IFJ0PWU9PntlLmlzQXdhaXRpbmdQcm9taXNlKCkmJihMLmF3YWl0aW5nUHJvbWlzZS5kZWxldGUoZSksTC5pbm5lclBhcmFtcy5nZXQoZSl8fGUuX2Rlc3Ryb3koKSl9LEZ0PShlLHQsbik9Pnt2YXIgbyxpLGEscj1tKCkscz1MZSYmYmUodCk7ImZ1bmN0aW9uIj09dHlwZW9mIG4ud2lsbENsb3NlJiZuLndpbGxDbG9zZSh0KSxzPyhzPWUsbz10LHQ9cixpPW4ucmV0dXJuRm9jdXMsYT1uLmRpZENsb3NlLFQuc3dhbENsb3NlRXZlbnRGaW5pc2hlZENhbGxiYWNrPVZ0LmJpbmQobnVsbCxzLHQsaSxhKSxvLmFkZEV2ZW50TGlzdGVuZXIoTGUsZnVuY3Rpb24oZSl7ZS50YXJnZXQ9PT1vJiYoVC5zd2FsQ2xvc2VFdmVudEZpbmlzaGVkQ2FsbGJhY2soKSxkZWxldGUgVC5zd2FsQ2xvc2VFdmVudEZpbmlzaGVkQ2FsbGJhY2spfSkpOlZ0KGUscixuLnJldHVybkZvY3VzLG4uZGlkQ2xvc2UpfSxVdD0oZSx0KT0+e3NldFRpbWVvdXQoKCk9PnsiZnVuY3Rpb24iPT10eXBlb2YgdCYmdC5iaW5kKGUucGFyYW1zKSgpLGUuX2Rlc3Ryb3koKX0pfTtmdW5jdGlvbiBXdChlLHQsbil7Y29uc3Qgbz1MLmRvbUNhY2hlLmdldChlKTt0LmZvckVhY2goZT0+e29bZV0uZGlzYWJsZWQ9bn0pfWZ1bmN0aW9uIHp0KGUsdCl7aWYoIWUpcmV0dXJuITE7aWYoInJhZGlvIj09PWUudHlwZSl7Y29uc3Qgbj1lLnBhcmVudE5vZGUucGFyZW50Tm9kZSxvPW4ucXVlcnlTZWxlY3RvckFsbCgiaW5wdXQiKTtmb3IobGV0IGU9MDtlPG8ubGVuZ3RoO2UrKylvW2VdLmRpc2FibGVkPXR9ZWxzZSBlLmRpc2FibGVkPXR9Y29uc3QgX3Q9ZT0+e2UuaXNBd2FpdGluZ1Byb21pc2UoKT8oS3QoTCxlKSxMLmF3YWl0aW5nUHJvbWlzZS5zZXQoZSwhMCkpOihLdChPdCxlKSxLdChMLGUpKX0sS3Q9KGUsdCk9Pntmb3IoY29uc3QgbiBpbiBlKWVbbl0uZGVsZXRlKHQpfTtlPU9iamVjdC5mcmVlemUoe2hpZGVMb2FkaW5nOkx0LGRpc2FibGVMb2FkaW5nOkx0LGdldElucHV0OmZ1bmN0aW9uKGUpe3ZhciB0PUwuaW5uZXJQYXJhbXMuZ2V0KGV8fHRoaXMpO3JldHVybihlPUwuZG9tQ2FjaGUuZ2V0KGV8fHRoaXMpKT9sZShlLnBvcHVwLHQuaW5wdXQpOm51bGx9LGNsb3NlOk50LGlzQXdhaXRpbmdQcm9taXNlOmZ1bmN0aW9uKCl7cmV0dXJuISFMLmF3YWl0aW5nUHJvbWlzZS5nZXQodGhpcyl9LHJlamVjdFByb21pc2U6ZnVuY3Rpb24oZSl7Y29uc3QgdD1PdC5zd2FsUHJvbWlzZVJlamVjdC5nZXQodGhpcyk7UnQodGhpcyksdCYmdChlKX0saGFuZGxlQXdhaXRpbmdQcm9taXNlOlJ0LGNsb3NlUG9wdXA6TnQsY2xvc2VNb2RhbDpOdCxjbG9zZVRvYXN0Ok50LGVuYWJsZUJ1dHRvbnM6ZnVuY3Rpb24oKXtXdCh0aGlzLFsiY29uZmlybUJ1dHRvbiIsImRlbnlCdXR0b24iLCJjYW5jZWxCdXR0b24iXSwhMSl9LGRpc2FibGVCdXR0b25zOmZ1bmN0aW9uKCl7V3QodGhpcyxbImNvbmZpcm1CdXR0b24iLCJkZW55QnV0dG9uIiwiY2FuY2VsQnV0dG9uIl0sITApfSxlbmFibGVJbnB1dDpmdW5jdGlvbigpe3JldHVybiB6dCh0aGlzLmdldElucHV0KCksITEpfSxkaXNhYmxlSW5wdXQ6ZnVuY3Rpb24oKXtyZXR1cm4genQodGhpcy5nZXRJbnB1dCgpLCEwKX0sc2hvd1ZhbGlkYXRpb25NZXNzYWdlOmZ1bmN0aW9uKGUpe2NvbnN0IHQ9TC5kb21DYWNoZS5nZXQodGhpcyk7dmFyIG49TC5pbm5lclBhcmFtcy5nZXQodGhpcyk7eSh0LnZhbGlkYXRpb25NZXNzYWdlLGUpLHQudmFsaWRhdGlvbk1lc3NhZ2UuY2xhc3NOYW1lPXBbInZhbGlkYXRpb24tbWVzc2FnZSJdLG4uY3VzdG9tQ2xhc3MmJm4uY3VzdG9tQ2xhc3MudmFsaWRhdGlvbk1lc3NhZ2UmJkEodC52YWxpZGF0aW9uTWVzc2FnZSxuLmN1c3RvbUNsYXNzLnZhbGlkYXRpb25NZXNzYWdlKSxCKHQudmFsaWRhdGlvbk1lc3NhZ2UpO2NvbnN0IG89dGhpcy5nZXRJbnB1dCgpO28mJihvLnNldEF0dHJpYnV0ZSgiYXJpYS1pbnZhbGlkIiwhMCksby5zZXRBdHRyaWJ1dGUoImFyaWEtZGVzY3JpYmVkYnkiLHBbInZhbGlkYXRpb24tbWVzc2FnZSJdKSx1ZShvKSxBKG8scC5pbnB1dGVycm9yKSl9LHJlc2V0VmFsaWRhdGlvbk1lc3NhZ2U6ZnVuY3Rpb24oKXt2YXIgZT1MLmRvbUNhY2hlLmdldCh0aGlzKTtlLnZhbGlkYXRpb25NZXNzYWdlJiZ4KGUudmFsaWRhdGlvbk1lc3NhZ2UpO2NvbnN0IHQ9dGhpcy5nZXRJbnB1dCgpO3QmJih0LnJlbW92ZUF0dHJpYnV0ZSgiYXJpYS1pbnZhbGlkIiksdC5yZW1vdmVBdHRyaWJ1dGUoImFyaWEtZGVzY3JpYmVkYnkiKSxrKHQscC5pbnB1dGVycm9yKSl9LGdldFByb2dyZXNzU3RlcHM6ZnVuY3Rpb24oKXtyZXR1cm4gTC5kb21DYWNoZS5nZXQodGhpcykucHJvZ3Jlc3NTdGVwc30sdXBkYXRlOmZ1bmN0aW9uKGUpe3ZhciB0PWcoKSxuPUwuaW5uZXJQYXJhbXMuZ2V0KHRoaXMpO2lmKCF0fHx3KHQsbi5oaWRlQ2xhc3MucG9wdXApKXJldHVybiBhKCJZb3UncmUgdHJ5aW5nIHRvIHVwZGF0ZSB0aGUgY2xvc2VkIG9yIGNsb3NpbmcgcG9wdXAsIHRoYXQgd29uJ3Qgd29yay4gVXNlIHRoZSB1cGRhdGUoKSBtZXRob2QgaW4gcHJlQ29uZmlybSBwYXJhbWV0ZXIgb3Igc2hvdyBhIG5ldyBwb3B1cC4iKTt0PSh0PT57Y29uc3Qgbj17fTtyZXR1cm4gT2JqZWN0LmtleXModCkuZm9yRWFjaChlPT57aWYoWShlKSluW2VdPXRbZV07ZWxzZSBhKCdJbnZhbGlkIHBhcmFtZXRlciB0byB1cGRhdGU6ICInLmNvbmNhdChlLCciLiBVcGRhdGFibGUgcGFyYW1zIGFyZSBsaXN0ZWQgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL3N3ZWV0YWxlcnQyL3N3ZWV0YWxlcnQyL2Jsb2IvbWFzdGVyL3NyYy91dGlscy9wYXJhbXMuanNcblxuSWYgeW91IHRoaW5rIHRoaXMgcGFyYW1ldGVyIHNob3VsZCBiZSB1cGRhdGFibGUsIHJlcXVlc3QgaXQgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL3N3ZWV0YWxlcnQyL3N3ZWV0YWxlcnQyL2lzc3Vlcy9uZXc/dGVtcGxhdGU9MDJfZmVhdHVyZV9yZXF1ZXN0Lm1kJykpfSksbn0pKGUpLG49T2JqZWN0LmFzc2lnbih7fSxuLHQpLHR0KHRoaXMsbiksTC5pbm5lclBhcmFtcy5zZXQodGhpcyxuKSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLHtwYXJhbXM6e3ZhbHVlOk9iamVjdC5hc3NpZ24oe30sdGhpcy5wYXJhbXMsZSksd3JpdGFibGU6ITEsZW51bWVyYWJsZTohMH19KX0sX2Rlc3Ryb3k6ZnVuY3Rpb24oKXt2YXIgZT1MLmRvbUNhY2hlLmdldCh0aGlzKTtjb25zdCB0PUwuaW5uZXJQYXJhbXMuZ2V0KHRoaXMpO3Q/KGUucG9wdXAmJlQuc3dhbENsb3NlRXZlbnRGaW5pc2hlZENhbGxiYWNrJiYoVC5zd2FsQ2xvc2VFdmVudEZpbmlzaGVkQ2FsbGJhY2soKSxkZWxldGUgVC5zd2FsQ2xvc2VFdmVudEZpbmlzaGVkQ2FsbGJhY2spLFQuZGVmZXJEaXNwb3NhbFRpbWVyJiYoY2xlYXJUaW1lb3V0KFQuZGVmZXJEaXNwb3NhbFRpbWVyKSxkZWxldGUgVC5kZWZlckRpc3Bvc2FsVGltZXIpLCJmdW5jdGlvbiI9PXR5cGVvZiB0LmRpZERlc3Ryb3kmJnQuZGlkRGVzdHJveSgpLGU9dGhpcyxfdChlKSxkZWxldGUgZS5wYXJhbXMsZGVsZXRlIFQua2V5ZG93bkhhbmRsZXIsZGVsZXRlIFQua2V5ZG93blRhcmdldCxkZWxldGUgVC5jdXJyZW50SW5zdGFuY2UpOl90KHRoaXMpfX0pO2NvbnN0IFl0PShlLHQpPT57dmFyIG49TC5pbm5lclBhcmFtcy5nZXQoZSk7aWYoIW4uaW5wdXQpcmV0dXJuIGwoJ1RoZSAiaW5wdXQiIHBhcmFtZXRlciBpcyBuZWVkZWQgdG8gYmUgc2V0IHdoZW4gdXNpbmcgcmV0dXJuSW5wdXRWYWx1ZU9uJy5jb25jYXQoSCh0KSkpO3ZhciBvPSgoZSx0KT0+e2NvbnN0IG49ZS5nZXRJbnB1dCgpO2lmKCFuKXJldHVybiBudWxsO3N3aXRjaCh0LmlucHV0KXtjYXNlImNoZWNrYm94IjpyZXR1cm4gbi5jaGVja2VkPzE6MDtjYXNlInJhZGlvIjpyZXR1cm4obz1uKS5jaGVja2VkP28udmFsdWU6bnVsbDtjYXNlImZpbGUiOnJldHVybihvPW4pLmZpbGVzLmxlbmd0aD9udWxsIT09by5nZXRBdHRyaWJ1dGUoIm11bHRpcGxlIik/by5maWxlczpvLmZpbGVzWzBdOm51bGw7ZGVmYXVsdDpyZXR1cm4gdC5pbnB1dEF1dG9UcmltP24udmFsdWUudHJpbSgpOm4udmFsdWV9dmFyIG99KShlLG4pO2lmKG4uaW5wdXRWYWxpZGF0b3Ipe3ZhciBpPWU7dmFyIGE9bzt2YXIgcj10O2NvbnN0IHM9TC5pbm5lclBhcmFtcy5nZXQoaSksYz0oaS5kaXNhYmxlSW5wdXQoKSxQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT51KHMuaW5wdXRWYWxpZGF0b3IoYSxzLnZhbGlkYXRpb25NZXNzYWdlKSkpKTtjLnRoZW4oZT0+e2kuZW5hYmxlQnV0dG9ucygpLGkuZW5hYmxlSW5wdXQoKSxlP2kuc2hvd1ZhbGlkYXRpb25NZXNzYWdlKGUpOigiZGVueSI9PT1yP1p0OiR0KShpLGEpfSl9ZWxzZSBlLmdldElucHV0KCkuY2hlY2tWYWxpZGl0eSgpPygiZGVueSI9PT10P1p0OiR0KShlLG8pOihlLmVuYWJsZUJ1dHRvbnMoKSxlLnNob3dWYWxpZGF0aW9uTWVzc2FnZShuLnZhbGlkYXRpb25NZXNzYWdlKSl9LFp0PSh0LG4pPT57Y29uc3QgZT1MLmlubmVyUGFyYW1zLmdldCh0fHx2b2lkIDApO2lmKGUuc2hvd0xvYWRlck9uRGVueSYmRChmKCkpLGUucHJlRGVueSl7TC5hd2FpdGluZ1Byb21pc2Uuc2V0KHR8fHZvaWQgMCwhMCk7Y29uc3Qgbz1Qcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT51KGUucHJlRGVueShuLGUudmFsaWRhdGlvbk1lc3NhZ2UpKSk7by50aGVuKGU9PnshMT09PWU/KHQuaGlkZUxvYWRpbmcoKSxSdCh0KSk6dC5jbG9zZVBvcHVwKHtpc0RlbmllZDohMCx2YWx1ZTp2b2lkIDA9PT1lP246ZX0pfSkuY2F0Y2goZT0+WHQodHx8dm9pZCAwLGUpKX1lbHNlIHQuY2xvc2VQb3B1cCh7aXNEZW5pZWQ6ITAsdmFsdWU6bn0pfSxKdD0oZSx0KT0+e2UuY2xvc2VQb3B1cCh7aXNDb25maXJtZWQ6ITAsdmFsdWU6dH0pfSxYdD0oZSx0KT0+e2UucmVqZWN0UHJvbWlzZSh0KX0sJHQ9KHQsbik9Pntjb25zdCBlPUwuaW5uZXJQYXJhbXMuZ2V0KHR8fHZvaWQgMCk7aWYoZS5zaG93TG9hZGVyT25Db25maXJtJiZEKCksZS5wcmVDb25maXJtKXt0LnJlc2V0VmFsaWRhdGlvbk1lc3NhZ2UoKSxMLmF3YWl0aW5nUHJvbWlzZS5zZXQodHx8dm9pZCAwLCEwKTtjb25zdCBvPVByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCk9PnUoZS5wcmVDb25maXJtKG4sZS52YWxpZGF0aW9uTWVzc2FnZSkpKTtvLnRoZW4oZT0+e0UoZWUoKSl8fCExPT09ZT8odC5oaWRlTG9hZGluZygpLFJ0KHQpKTpKdCh0LHZvaWQgMD09PWU/bjplKX0pLmNhdGNoKGU9Plh0KHR8fHZvaWQgMCxlKSl9ZWxzZSBKdCh0LG4pfSxHdD0obixlLG8pPT57ZS5wb3B1cC5vbmNsaWNrPSgpPT57dmFyIGUsdD1MLmlubmVyUGFyYW1zLmdldChuKTt0JiYoKGU9dCkuc2hvd0NvbmZpcm1CdXR0b258fGUuc2hvd0RlbnlCdXR0b258fGUuc2hvd0NhbmNlbEJ1dHRvbnx8ZS5zaG93Q2xvc2VCdXR0b258fHQudGltZXJ8fHQuaW5wdXQpfHxvKGouY2xvc2UpfX07bGV0IFF0PSExO2NvbnN0IGVuPXQ9Pnt0LnBvcHVwLm9ubW91c2Vkb3duPSgpPT57dC5jb250YWluZXIub25tb3VzZXVwPWZ1bmN0aW9uKGUpe3QuY29udGFpbmVyLm9ubW91c2V1cD12b2lkIDAsZS50YXJnZXQ9PT10LmNvbnRhaW5lciYmKFF0PSEwKX19fSx0bj10PT57dC5jb250YWluZXIub25tb3VzZWRvd249KCk9Pnt0LnBvcHVwLm9ubW91c2V1cD1mdW5jdGlvbihlKXt0LnBvcHVwLm9ubW91c2V1cD12b2lkIDAsZS50YXJnZXQhPT10LnBvcHVwJiYhdC5wb3B1cC5jb250YWlucyhlLnRhcmdldCl8fChRdD0hMCl9fX0sbm49KG4sbyxpKT0+e28uY29udGFpbmVyLm9uY2xpY2s9ZT0+e3ZhciB0PUwuaW5uZXJQYXJhbXMuZ2V0KG4pO1F0P1F0PSExOmUudGFyZ2V0PT09by5jb250YWluZXImJlIodC5hbGxvd091dHNpZGVDbGljaykmJmkoai5iYWNrZHJvcCl9fSxvbj1lPT4ib2JqZWN0Ij09dHlwZW9mIGUmJmUuanF1ZXJ5LGFuPWU9PmUgaW5zdGFuY2VvZiBFbGVtZW50fHxvbihlKTtjb25zdCBybj0oKT0+e2lmKFQudGltZW91dCl7e2NvbnN0IG49bmUoKTt2YXIgZT1wYXJzZUludCh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShuKS53aWR0aCksdD0obi5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgidHJhbnNpdGlvbiIpLG4uc3R5bGUud2lkdGg9IjEwMCUiLHBhcnNlSW50KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG4pLndpZHRoKSksZT1lL3QqMTAwO24uc3R5bGUucmVtb3ZlUHJvcGVydHkoInRyYW5zaXRpb24iKSxuLnN0eWxlLndpZHRoPSIiLmNvbmNhdChlLCIlIil9cmV0dXJuIFQudGltZW91dC5zdG9wKCl9fSxzbj0oKT0+e3ZhciBlO2lmKFQudGltZW91dClyZXR1cm4gZT1ULnRpbWVvdXQuc3RhcnQoKSxzZShlKSxlfTtsZXQgY249ITE7Y29uc3QgbG49e307Y29uc3QgdW49dD0+e2ZvcihsZXQgZT10LnRhcmdldDtlJiZlIT09ZG9jdW1lbnQ7ZT1lLnBhcmVudE5vZGUpZm9yKGNvbnN0IG8gaW4gbG4pe3ZhciBuPWUuZ2V0QXR0cmlidXRlKG8pO2lmKG4pcmV0dXJuIHZvaWQgbG5bb10uZmlyZSh7dGVtcGxhdGU6bn0pfX07dmFyIGRuPU9iamVjdC5mcmVlemUoe2lzVmFsaWRQYXJhbWV0ZXI6Syxpc1VwZGF0YWJsZVBhcmFtZXRlcjpZLGlzRGVwcmVjYXRlZFBhcmFtZXRlcjpaLGFyZ3NUb1BhcmFtczpuPT57Y29uc3Qgbz17fTtyZXR1cm4ib2JqZWN0IiE9dHlwZW9mIG5bMF18fGFuKG5bMF0pP1sidGl0bGUiLCJodG1sIiwiaWNvbiJdLmZvckVhY2goKGUsdCk9Pnt0PW5bdF07InN0cmluZyI9PXR5cGVvZiB0fHxhbih0KT9vW2VdPXQ6dm9pZCAwIT09dCYmbCgiVW5leHBlY3RlZCB0eXBlIG9mICIuY29uY2F0KGUsJyEgRXhwZWN0ZWQgInN0cmluZyIgb3IgIkVsZW1lbnQiLCBnb3QgJykuY29uY2F0KHR5cGVvZiB0KSl9KTpPYmplY3QuYXNzaWduKG8sblswXSksb30saXNWaXNpYmxlOigpPT5FKGcoKSksY2xpY2tDb25maXJtOmp0LGNsaWNrRGVueTooKT0+ZigpJiZmKCkuY2xpY2soKSxjbGlja0NhbmNlbDooKT0+YigpJiZiKCkuY2xpY2soKSxnZXRDb250YWluZXI6bSxnZXRQb3B1cDpnLGdldFRpdGxlOlgsZ2V0SHRtbENvbnRhaW5lcjokLGdldEltYWdlOkcsZ2V0SWNvbjpzLGdldElucHV0TGFiZWw6KCk9Pm4ocFsiaW5wdXQtbGFiZWwiXSksZ2V0Q2xvc2VCdXR0b246b2UsZ2V0QWN0aW9uczp2LGdldENvbmZpcm1CdXR0b246aCxnZXREZW55QnV0dG9uOmYsZ2V0Q2FuY2VsQnV0dG9uOmIsZ2V0TG9hZGVyOmQsZ2V0Rm9vdGVyOnRlLGdldFRpbWVyUHJvZ3Jlc3NCYXI6bmUsZ2V0Rm9jdXNhYmxlRWxlbWVudHM6aWUsZ2V0VmFsaWRhdGlvbk1lc3NhZ2U6ZWUsaXNMb2FkaW5nOigpPT5nKCkuaGFzQXR0cmlidXRlKCJkYXRhLWxvYWRpbmciKSxmaXJlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsdD1uZXcgQXJyYXkoZSksbj0wO248ZTtuKyspdFtuXT1hcmd1bWVudHNbbl07cmV0dXJuIG5ldyB0aGlzKC4uLnQpfSxtaXhpbjpmdW5jdGlvbihuKXtjbGFzcyBlIGV4dGVuZHMgdGhpc3tfbWFpbihlLHQpe3JldHVybiBzdXBlci5fbWFpbihlLE9iamVjdC5hc3NpZ24oe30sbix0KSl9fXJldHVybiBlfSxzaG93TG9hZGluZzpELGVuYWJsZUxvYWRpbmc6RCxnZXRUaW1lckxlZnQ6KCk9PlQudGltZW91dCYmVC50aW1lb3V0LmdldFRpbWVyTGVmdCgpLHN0b3BUaW1lcjpybixyZXN1bWVUaW1lcjpzbix0b2dnbGVUaW1lcjooKT0+e3ZhciBlPVQudGltZW91dDtyZXR1cm4gZSYmKGUucnVubmluZz9ybjpzbikoKX0saW5jcmVhc2VUaW1lcjplPT57aWYoVC50aW1lb3V0KXJldHVybiBlPVQudGltZW91dC5pbmNyZWFzZShlKSxzZShlLCEwKSxlfSxpc1RpbWVyUnVubmluZzooKT0+VC50aW1lb3V0JiZULnRpbWVvdXQuaXNSdW5uaW5nKCksYmluZENsaWNrSGFuZGxlcjpmdW5jdGlvbigpe3ZhciBlPTA8YXJndW1lbnRzLmxlbmd0aCYmdm9pZCAwIT09YXJndW1lbnRzWzBdP2FyZ3VtZW50c1swXToiZGF0YS1zd2FsLXRlbXBsYXRlIjtsbltlXT10aGlzLGNufHwoZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsdW4pLGNuPSEwKX19KTtsZXQgcG47Y2xhc3MgSXtjb25zdHJ1Y3Rvcigpe2lmKCJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93KXtwbj10aGlzO2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLHQ9bmV3IEFycmF5KGUpLG49MDtuPGU7bisrKXRbbl09YXJndW1lbnRzW25dO3ZhciBvPU9iamVjdC5mcmVlemUodGhpcy5jb25zdHJ1Y3Rvci5hcmdzVG9QYXJhbXModCkpLG89KE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMse3BhcmFtczp7dmFsdWU6byx3cml0YWJsZTohMSxlbnVtZXJhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMH19KSx0aGlzLl9tYWluKHRoaXMucGFyYW1zKSk7TC5wcm9taXNlLnNldCh0aGlzLG8pfX1fbWFpbihlKXt2YXIgdD0xPGFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06e30sZT0oSihPYmplY3QuYXNzaWduKHt9LHQsZSkpLFQuY3VycmVudEluc3RhbmNlJiYoVC5jdXJyZW50SW5zdGFuY2UuX2Rlc3Ryb3koKSxhZSgpJiZvdCgpKSxULmN1cnJlbnRJbnN0YW5jZT10aGlzLGduKGUsdCkpLHQ9KG10KGUpLE9iamVjdC5mcmVlemUoZSksVC50aW1lb3V0JiYoVC50aW1lb3V0LnN0b3AoKSxkZWxldGUgVC50aW1lb3V0KSxjbGVhclRpbWVvdXQoVC5yZXN0b3JlRm9jdXNUaW1lb3V0KSxobih0aGlzKSk7cmV0dXJuIHR0KHRoaXMsZSksTC5pbm5lclBhcmFtcy5zZXQodGhpcyxlKSxtbih0aGlzLHQsZSl9dGhlbihlKXtjb25zdCB0PUwucHJvbWlzZS5nZXQodGhpcyk7cmV0dXJuIHQudGhlbihlKX1maW5hbGx5KGUpe2NvbnN0IHQ9TC5wcm9taXNlLmdldCh0aGlzKTtyZXR1cm4gdC5maW5hbGx5KGUpfX1jb25zdCBtbj0obCx1LGQpPT5uZXcgUHJvbWlzZSgoZSx0KT0+e2NvbnN0IG49ZT0+e2wuY2xvc2VQb3B1cCh7aXNEaXNtaXNzZWQ6ITAsZGlzbWlzczplfSl9O3ZhciBvLGksYTtPdC5zd2FsUHJvbWlzZVJlc29sdmUuc2V0KGwsZSksT3Quc3dhbFByb21pc2VSZWplY3Quc2V0KGwsdCksdS5jb25maXJtQnV0dG9uLm9uY2xpY2s9KCk9Pnt2YXIgZT1sLHQ9TC5pbm5lclBhcmFtcy5nZXQoZSk7ZS5kaXNhYmxlQnV0dG9ucygpLHQuaW5wdXQ/WXQoZSwiY29uZmlybSIpOiR0KGUsITApfSx1LmRlbnlCdXR0b24ub25jbGljaz0oKT0+e3ZhciBlPWwsdD1MLmlubmVyUGFyYW1zLmdldChlKTtlLmRpc2FibGVCdXR0b25zKCksdC5yZXR1cm5JbnB1dFZhbHVlT25EZW55P1l0KGUsImRlbnkiKTpadChlLCExKX0sdS5jYW5jZWxCdXR0b24ub25jbGljaz0oKT0+e3ZhciBlPWwsdD1uO2UuZGlzYWJsZUJ1dHRvbnMoKSx0KGouY2FuY2VsKX0sdS5jbG9zZUJ1dHRvbi5vbmNsaWNrPSgpPT5uKGouY2xvc2UpLGU9bCx0PXUsYT1uLEwuaW5uZXJQYXJhbXMuZ2V0KGUpLnRvYXN0P0d0KGUsdCxhKTooZW4odCksdG4odCksbm4oZSx0LGEpKSxvPWwsZT1ULHQ9ZCxpPW4sTXQoZSksdC50b2FzdHx8KGUua2V5ZG93bkhhbmRsZXI9ZT0+SHQobyxlLGkpLGUua2V5ZG93blRhcmdldD10LmtleWRvd25MaXN0ZW5lckNhcHR1cmU/d2luZG93OmcoKSxlLmtleWRvd25MaXN0ZW5lckNhcHR1cmU9dC5rZXlkb3duTGlzdGVuZXJDYXB0dXJlLGUua2V5ZG93blRhcmdldC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIixlLmtleWRvd25IYW5kbGVyLHtjYXB0dXJlOmUua2V5ZG93bkxpc3RlbmVyQ2FwdHVyZX0pLGUua2V5ZG93bkhhbmRsZXJBZGRlZD0hMCksYT1sLCJzZWxlY3QiPT09KHQ9ZCkuaW5wdXR8fCJyYWRpbyI9PT10LmlucHV0P0J0KGEsdCk6WyJ0ZXh0IiwiZW1haWwiLCJudW1iZXIiLCJ0ZWwiLCJ0ZXh0YXJlYSJdLmluY2x1ZGVzKHQuaW5wdXQpJiYoRih0LmlucHV0VmFsdWUpfHxVKHQuaW5wdXRWYWx1ZSkpJiYoRChoKCkpLHh0KGEsdCkpO3t2YXIgcj1kO2NvbnN0IHM9bSgpLGM9ZygpOyJmdW5jdGlvbiI9PXR5cGVvZiByLndpbGxPcGVuJiZyLndpbGxPcGVuKGMpLGU9d2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSkub3ZlcmZsb3dZLFB0KHMsYyxyKSxzZXRUaW1lb3V0KCgpPT57QXQocyxjKX0sd3QpLGFlKCkmJihrdChzLHIuc2Nyb2xsYmFyUGFkZGluZyxlKSxudCgpKSxyZSgpfHxULnByZXZpb3VzQWN0aXZlRWxlbWVudHx8KFQucHJldmlvdXNBY3RpdmVFbGVtZW50PWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpLCJmdW5jdGlvbiI9PXR5cGVvZiByLmRpZE9wZW4mJnNldFRpbWVvdXQoKCk9PnIuZGlkT3BlbihjKSksayhzLHBbIm5vLXRyYW5zaXRpb24iXSl9Zm4oVCxkLG4pLGJuKHUsZCksc2V0VGltZW91dCgoKT0+e3UuY29udGFpbmVyLnNjcm9sbFRvcD0wfSl9KSxnbj0oZSx0KT0+e3ZhciBuPShlPT57ZT0ic3RyaW5nIj09dHlwZW9mIGUudGVtcGxhdGU/ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlLnRlbXBsYXRlKTplLnRlbXBsYXRlO2lmKCFlKXJldHVybnt9O2U9ZS5jb250ZW50LGR0KGUpLGU9T2JqZWN0LmFzc2lnbihhdChlKSxydChlKSxzdChlKSxjdChlKSxsdChlKSx1dChlLGl0KSk7cmV0dXJuIGV9KShlKTtjb25zdCBvPU9iamVjdC5hc3NpZ24oe30scix0LG4sZSk7cmV0dXJuIG8uc2hvd0NsYXNzPU9iamVjdC5hc3NpZ24oe30sci5zaG93Q2xhc3Msby5zaG93Q2xhc3MpLG8uaGlkZUNsYXNzPU9iamVjdC5hc3NpZ24oe30sci5oaWRlQ2xhc3Msby5oaWRlQ2xhc3MpLG99LGhuPWU9Pnt2YXIgdD17cG9wdXA6ZygpLGNvbnRhaW5lcjptKCksYWN0aW9uczp2KCksY29uZmlybUJ1dHRvbjpoKCksZGVueUJ1dHRvbjpmKCksY2FuY2VsQnV0dG9uOmIoKSxsb2FkZXI6ZCgpLGNsb3NlQnV0dG9uOm9lKCksdmFsaWRhdGlvbk1lc3NhZ2U6ZWUoKSxwcm9ncmVzc1N0ZXBzOlEoKX07cmV0dXJuIEwuZG9tQ2FjaGUuc2V0KGUsdCksdH0sZm49KGUsdCxuKT0+e3ZhciBvPW5lKCk7eChvKSx0LnRpbWVyJiYoZS50aW1lb3V0PW5ldyBndCgoKT0+e24oInRpbWVyIiksZGVsZXRlIGUudGltZW91dH0sdC50aW1lciksdC50aW1lclByb2dyZXNzQmFyJiYoQihvKSxDKG8sdCwidGltZXJQcm9ncmVzc0JhciIpLHNldFRpbWVvdXQoKCk9PntlLnRpbWVvdXQmJmUudGltZW91dC5ydW5uaW5nJiZzZSh0LnRpbWVyKX0pKSl9LGJuPShlLHQpPT57aWYoIXQudG9hc3QpcmV0dXJuIFIodC5hbGxvd0VudGVyS2V5KT92b2lkKHZuKGUsdCl8fER0KHQsLTEsMSkpOnluKCl9LHZuPShlLHQpPT50LmZvY3VzRGVueSYmRShlLmRlbnlCdXR0b24pPyhlLmRlbnlCdXR0b24uZm9jdXMoKSwhMCk6dC5mb2N1c0NhbmNlbCYmRShlLmNhbmNlbEJ1dHRvbik/KGUuY2FuY2VsQnV0dG9uLmZvY3VzKCksITApOiEoIXQuZm9jdXNDb25maXJtfHwhRShlLmNvbmZpcm1CdXR0b24pKSYmKGUuY29uZmlybUJ1dHRvbi5mb2N1cygpLCEwKSx5bj0oKT0+e2RvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCYmImZ1bmN0aW9uIj09dHlwZW9mIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuYmx1ciYmZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyKCl9LHduPShPYmplY3QuYXNzaWduKEkucHJvdG90eXBlLGUpLE9iamVjdC5hc3NpZ24oSSxkbiksT2JqZWN0LmtleXMoZSkuZm9yRWFjaChlPT57SVtlXT1mdW5jdGlvbigpe2lmKHBuKXJldHVybiBwbltlXSguLi5hcmd1bWVudHMpfX0pLEkuRGlzbWlzc1JlYXNvbj1qLEkudmVyc2lvbj0iMTEuNC44IixJKTtyZXR1cm4gd24uZGVmYXVsdD13bn0pLHZvaWQgMCE9PXRoaXMmJnRoaXMuU3dlZXRhbGVydDImJih0aGlzLnN3YWw9dGhpcy5zd2VldEFsZXJ0PXRoaXMuU3dhbD10aGlzLlN3ZWV0QWxlcnQ9dGhpcy5Td2VldGFsZXJ0Mik7
// ==/UserScript==

(function () {
    'use strict';

    const API_BASE = 'https://zyk.icve.com.cn/prod-api/teacher/courseContent';

    const AUTH = {
        getToken: () => document.cookie.match(/Token=([^;]+)/)?.[1],
        headers: () => ({ Authorization: `Bearer ${AUTH.getToken()}` })
    };

    class ResourceManager {
        constructor() {
            this.downloadQueue = [];
            this.isDownloading = false;
            this.fileStats = { all: 0, video: 0, doc: 0, ppt: 0 };
            this.initUI();
        }

        initUI() {
            this.injectStyles();
            this.createMainButton();
            this.createModal();
        }

        createMainButton() {
            const btn = Object.assign(document.createElement('button'), {
                className: 'icve-dl-btn',
                textContent: '📁 资源管理器',
                onclick: () => this.loadResources()
            });
            Object.assign(btn.style, {
                position: 'fixed',
                bottom: '20px',
                right: '20px',
                zIndex: 9999,
                padding: '12px 24px',
                background: '#2196F3',
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                boxShadow: '0 2px 10px rgba(0,0,0,0.2)'
            });
            document.body.appendChild(btn);
        }

        getFileType(ext) {
            const videoExtensions = [
                'mp4', 'avi', 'mov', 'wmv', 'flv',
                'mkv', 'webm', 'mpg', 'mpeg', '3gp'
            ];
            const pptExtensions = ['ppt', 'pptx']; // 新增PPT类型判断
            if (videoExtensions.includes(ext)) return 'video';
            if (pptExtensions.includes(ext)) return 'ppt'; // 返回ppt类型
            return 'doc';
        }

        createModal() {
            this.modal = Object.assign(document.createElement('div'), {
                className: 'icve-modal',
                innerHTML: `
                    <div class="header">
                        <h3>课程资源列表</h3>
                        <span class="close">&times;</span>
                    </div>
                <div class="toolbar">
                    <button class="filter active" data-type="all">全部</button>
                    <button class="filter" data-type="video">视频</button>
                    <button class="filter" data-type="doc">文档</button>
                    <button class="filter" data-type="ppt">PPT</button>
                    <button class="select-all">全选</button>
                    <button class="download-selected">下载选中项</button>
                </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" class="master-check"></th>
                                    <th>文件名</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody class="file-list"></tbody>
                        </table>
                    </div>
                `
            });

            this.modal.addEventListener('click', e => {
                const target = e.target;
                if (target.classList.contains('close')) this.hideModal();
                if (target.classList.contains('master-check')) this.toggleAll(target.checked);
                if (target.classList.contains('filter')) this.handleFilter(target);
                if (target.classList.contains('select-all')) this.toggleAll(true);
                if (target.classList.contains('download-selected')) this.processDownload();
                if (target.classList.contains('copy-btn')) this.handleCopy(target);
                if (target.classList.contains('download-btn')) this.handleSingleDownload(target);
                if (target.matches('input[type="checkbox"]')) this.updateSelectedCount();
            });

            document.body.appendChild(this.modal);
        }

        async loadResources() {
            try {
                const courseId = await this.waitForCourseId();
                const data = await this.fetchCourseData(courseId);
                const files = this.parseResources(data.data);
                this.renderFileList(files);
                this.updateButtonCounts();
                this.showModal();
            } catch (error) {
                this.showAlert('错误', error.message, 'error');
            }
        }

        async fetchCourseData(courseId) {
            const response = await this.apiRequest(`${API_BASE}/studyDesignList?courseInfoId=${courseId}`);
            if (!response.data?.length) throw new Error('未找到课程资源');
            return response;
        }

        parseResources(nodes) {
            const result = [];
            const seenUrls = new Set();

            const traverse = (items, path = []) => {
                items.forEach(item => {
                    const newPath = [...path, item.name];
                    if (item.fileUrl) {
                        // 去重逻辑：只保留第一个出现的fileUrl
                        if (item.fileUrl && seenUrls.has(item.fileUrl)) return;
                        if (item.fileUrl) seenUrls.add(item.fileUrl);

                        const fileExt = this.getFileExt(item.fileUrl);
                        result.push({
                            id: item.fileId || item.id,
                            name: item.name,
                            type: this.getFileType(fileExt),
                            ext: fileExt,
                            path: path.join(' - ')
                        });
                    }
                    if (item.children) traverse(item.children, newPath);
                });
            };

            traverse(nodes);

            // 统计文件类型数量
            this.fileStats = result.reduce((stats, file) => {
                stats.all++;
                stats[file.type]++;
                return stats;
            }, { all: 0, video: 0, doc: 0, ppt: 0 });

            return result;
        }

        getFileExt(url) {
            return (url.split('.').pop() || '').split(/[?#]/)[0].toLowerCase();
        }

        handleFilter(target) {
            const type = target.dataset.type;
            this.modal.querySelectorAll('.filter').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');

            this.modal.querySelectorAll('tr[data-type]').forEach(row => {
                row.style.display = type === 'all' || row.dataset.type === type ? '' : 'none';
            });

            this.updateSelectedCount();
            this.modal.querySelector('.master-check').checked = false;
        }

        updateButtonCounts() {
            // 更新筛选按钮计数
            this.modal.querySelectorAll('.filter').forEach(btn => {
                const type = btn.dataset.type;
                btn.textContent = `${{
                    all: '全部',
                    video: '视频',
                    doc: '文档',
                    ppt: 'PPT'
                }[type]}（${this.fileStats[type]}）`;
            });
        }

        async processDownload() {
            const selected = this.getSelectedFiles();
            if (!selected.length) return this.showAlert('提示', '请先选择要下载的文件', 'warning');

            selected.forEach(file => this.updateFileStatus(file.id, '等待下载'));
            this.downloadQueue.push(...selected);
            this.showAlert('下载队列', `已添加${selected.length}个文件到下载队列`, 'info');
            this.processQueue();
        }

        async processQueue() {
            if (this.isDownloading || !this.downloadQueue.length) return;
            this.isDownloading = true;

            while (this.downloadQueue.length > 0) {
                const file = this.downloadQueue.shift();
                try {
                    this.updateFileStatus(file.id, '开始下载');
                    await this.downloadFile(file);
                } catch (error) {
                    this.updateFileStatus(file.id, `失败: ${error.message}`);
                }
            }

            this.isDownloading = false;
        }

        async fetchAndDownloadFile(url, filename, fileId) {
            return new Promise((resolve, reject) => {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url: url,
                    responseType: 'blob',
                    headers: { 'Origin': window.location.origin },
                    onprogress: (progress) => {
                        if (progress.lengthComputable) {
                            const percent = Math.round((progress.loaded / progress.total) * 100);
                            this.updateFileStatus(fileId, `下载中 ${percent}%`);
                        }
                    },
                    onload: (response) => {
                        if (response.status === 200) {
                            const blob = new Blob([response.response], { type: response.responseHeaders['Content-Type'] });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            this.updateFileStatus(fileId, '下载完成');
                            resolve();
                        } else {
                            this.updateFileStatus(fileId, `失败: HTTP ${response.status}`);
                            reject(new Error(`HTTP ${response.status}`));
                        }
                    },
                    onerror: (error) => {
                        this.updateFileStatus(fileId, '下载失败');
                        reject(error);
                    }
                });
            });
        }

        async downloadFile(file) {
            try {
                this.updateFileStatus(file.id, '获取地址中...');
                const { data } = await this.apiRequest(`${API_BASE}/${file.id}`);
                if (!data?.fileUrl) throw new Error('无效的下载地址');

                await this.fetchAndDownloadFile(data.fileUrl, `${file.name}`, file.id);
            } catch (error) {
                this.updateFileStatus(file.id, `失败: ${error.message}`);
                throw error;
            }
        }

        handleSingleDownload(button) {
            const row = button.closest('tr');
            const fileId = row.dataset.id;
            const fileName = row.cells[1].textContent;
            const fileExt = row.dataset.type;

            this.updateFileStatus(fileId, '开始下载');
            this.downloadFile({
                id: fileId,
                name: fileName,
                ext: fileExt
            }).catch(() => { });
        }

        handleCopy(button) {
            const row = button.closest('tr');
            const fileId = row.dataset.id;

            this.apiRequest(`${API_BASE}/${fileId}`)
                .then(({ data }) => {
                    GM_setClipboard(data.fileUrl, 'text');
                    this.showAlert('成功', '下载地址已复制到剪贴板', 'success');
                })
                .catch(() => {
                    this.showAlert('错误', '获取下载地址失败', 'error');
                });
        }

        renderFileList(files) {
            const tbody = this.modal.querySelector('.file-list');
            tbody.innerHTML = files.map(file => `
                <tr data-id="${file.id}" data-type="${file.type}">
                    <td><input type="checkbox"></td>
                    <td title="${file.path}">${file.name}.${file.ext}</td>
                    <td class="status">未下载</td>
                    <td>
                        <button class="copy-btn">获取地址</button>
                        <button class="download-btn">下载</button>
                    </td>
                </tr>
            `).join('');
        }

        updateFileStatus(id, text) {
            const row = this.modal.querySelector(`tr[data-id="${id}"]`);
            if (row) row.querySelector('.status').textContent = text;
        }

        updateSelectedCount() {
            const count = this.getSelectedFiles().length;
            this.modal.querySelector('.download-selected').textContent = `下载选中项（${count}）`;
        }

        async waitForCourseId() {
            return new Promise(resolve => {
                const check = () => {
                    const vue = document.querySelector('#app')?.__vue__;
                    const courseId = vue?.$store?.getters?.courseInfo?.courseInfoId;
                    if (courseId) resolve(courseId);
                    else setTimeout(check, 500);
                };
                check();
            });
        }

        apiRequest(url) {
            return new Promise((resolve, reject) => {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url,
                    headers: AUTH.headers(),
                    onload: res => (res.status === 200)
                        ? resolve(JSON.parse(res.responseText))
                        : reject(new Error(`HTTP ${res.status}`)),
                    onerror: reject
                });
            });
        }

        getSelectedFiles() {
            return Array.from(this.modal.querySelectorAll('tbody tr:not([style*="none"]) input:checked'))
                .map(input => {
                    const row = input.closest('tr');
                    return {
                        id: row.dataset.id,
                        name: row.cells[1].textContent,
                        ext: row.dataset.type
                    };
                });
        }
        toggleAll(checked) {
            this.modal.querySelectorAll('tbody tr:not([style*="none"]) input[type="checkbox"]')
                .forEach(input => input.checked = checked);
            this.updateSelectedCount();
        }


        showModal() {
            this.modal.style.display = 'block';
            Object.assign(this.modal.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                background: 'white',
                padding: '20px',
                borderRadius: '8px',
                boxShadow: '0 0 20px rgba(0,0,0,0.2)',
                zIndex: 10000,
                maxWidth: '90vw',
                maxHeight: '80vh',
                overflow: 'auto'
            });
        }

        hideModal() {
            this.modal.style.display = 'none';
        }

        showAlert(title, text, icon) {
            Swal.fire({
                title,
                text,
                icon,
                position: 'top-end',
                toast: true,
                timer: 3000,
                showConfirmButton: false,
                customClass: {
                    popup: 'icve-alert'
                }
            });
        }

        injectStyles() {
            const css = `
                .icve-modal {
                    display: none;
                    background: white;
                    min-width: 800px;
                    font-family: system-ui, -apple-system, sans-serif;
                }
                .icve-modal .header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    border-bottom: 1px solid #eee;
                }
                .icve-modal .close {
                    cursor: pointer;
                    font-size: 24px;
                    color: #666;
                    padding: 0 8px;
                }
                .icve-modal .close:hover {
                    color: #333;
                }
                .icve-modal .toolbar {
                    padding: 10px;
                    background: #f8f9fa;
                    display: flex;
                    gap: 8px;
                    border-bottom: 1px solid #eee;
                }
                .icve-modal .toolbar button {
                    padding: 6px 12px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    cursor: pointer;
                    background: white;
                    transition: all 0.2s;
                }
                .icve-modal .toolbar button:hover {
                    background: #f0f0f0;
                }
                .icve-modal .toolbar button.active {
                    background: #9C27B0 !important;
                    color: white !important;
                    border-color: #7B1FA2;
                }
                .icve-modal .table-wrap {
                    padding: 15px;
                }
                .icve-modal table {
                    width: 100%;
                    border-collapse: collapse;
                }
                .icve-modal th, .icve-modal td {
                    padding: 12px;
                    border: 1px solid #eee;
                    text-align: left;
                }
                .icve-modal th {
                    background: #f8f9fa;
                    font-weight: 500;
                }
                .status {
                    color: #666;
                    min-width: 100px;
                    font-size: 0.9em;
                }
                .download-btn {
                    margin-left: 8px;
                    background: #4CAF50 !important;
                    color: white !important;
                    border-color: #45a049 !important;
                }
                .copy-btn {
                    background: #2196F3 !important;
                    color: white !important;
                    border-color: #1976D2 !important;
                }
                .icve-alert {
                    z-index: 10001 !important;
                    margin-top: 50px !important;
                }
            `;
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        }
    }

    window.addEventListener('load', () => new ResourceManager());
})();
